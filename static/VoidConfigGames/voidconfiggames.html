<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Void Network Admin Console</title>
    <style>
        body {
            background-color: #000;
            color: #0f0;
            font-family: monospace;
            padding: 20px;
            margin: 0;
        }
        #terminal {
            width: 100%;
            height: 80vh;
            background-color: #111;
            border: 1px solid #0f0;
            padding: 10px;
            overflow-y: auto;
            white-space: pre-wrap;
            box-sizing: border-box;
        }
        #commandInput {
            width: 100%;
            background-color: #111;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 10px;
            margin-top: 10px;
            font-family: monospace;
            box-sizing: border-box;
        }
        .success {
            color: #0f0;
        }
        .error {
            color: #f00;
        }
        .info {
            color: #0ff;
        }
        .warning {
            color: #ff0;
        }
        #loginForm {
            background-color: #111;
            border: 1px solid #0f0;
            padding: 20px;
            margin: 20px auto;
            max-width: 400px;
            text-align: center;
        }
        input[type="email"], input[type="password"] {
            width: 100%;
            background-color: #111;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            box-sizing: border-box;
        }
        button {
            background-color: #111;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 10px 20px;
            margin-top: 10px;
            font-family: monospace;
            cursor: pointer;
        }
        button:hover {
            background-color: #0f0;
            color: #111;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div id="loginForm">
        <h2>Void Network Admin Login</h2>
        <input type="email" id="emailInput" placeholder="ADMIN" value="ADMIN" autofocus>
        <input type="password" id="passwordInput" placeholder="Password">
        <button id="loginButton">Login</button>
        <div id="loginMessage" class="error hidden"></div>
    </div>

    <div id="adminConsole" class="hidden">
        <div id="terminal"></div>
        <input type="text" id="commandInput" placeholder="Enter command...">
    </div>
    
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, deleteUser } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, getDocs, updateDoc, setDoc, query, limit, where, deleteDoc, orderBy } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";

        // Firebase Configuration - UPDATED
        const firebaseConfig = {
            apiKey: "AIzaSyCkAp_GCGCtw4zv7GgHJOE9GPgIaPEuOvQ",
            authDomain: "void-games-c8d9e.firebaseapp.com",
            projectId: "void-games-c8d9e",
            storageBucket: "void-games-c8d9e.firebasestorage.app",
            messagingSenderId: "1063089929776",
            appId: "1:1063089929776:web:8e226a23a4f3ab9c5777f5"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // DOM Elements
        const loginForm = document.getElementById('loginForm');
        const emailInput = document.getElementById('emailInput');
        const passwordInput = document.getElementById('passwordInput');
        const loginButton = document.getElementById('loginButton');
        const loginMessage = document.getElementById('loginMessage');
        const adminConsole = document.getElementById('adminConsole');
        const terminal = document.getElementById('terminal');
        const commandInput = document.getElementById('commandInput');
        
        // Admin email constant - THE ONLY EMAIL ALLOWED TO ACCESS THE TERMINAL
        const ADMIN_EMAIL = "six7588@gmail.com";
        
        // Hardcoded known user IDs from Firebase Auth UI - with corrected spelling
        const KNOWN_USERS = {
            "KIsAtjOwRpdVDOL3VPrDBACSxdw1": "six7588@gmail.com",
            "GU9JmuJistfcjKLwtJLmj5BELHs2": "nigatikler@gmail.com",
            "mtl6j5MsEwYhfVfT1yw9JmrSfMV2": "1q2w3e4r5t6y7u8i9o0p@gmail.com",
            "ku8A1MuC6jWJxEnPIb9nYCY2MnH2": "mjbalkovski@gmail.com", // Corrected spelling
            "Ga450aQRGGMqUOgFVGs62fRnZ6l1": "svalenciarivera@isdkids.org",
            "3qJsAc8TsbZzx0SZdfduH7ijLuP2": "dfsgdsgr@gamil.comsd",
            "dcxtOHGcfrQ12XBrSz04MhQzEbq1": "shrey436@proton.me",
            "44b4NFWyEnSPhCsofxMkbkIP1vt1": "gvrelectrodude@gmail.com",
            "Wtc6hcUIzmORUJxJFc5nJVPgjRE2": "shrey150436@gmail.com",
            "QC8YOG6kCNZTg5QMyIHnXZoJ0cH2": "unknown@example.com", // Added the unknown ID you mentioned
            "mVXU2RP0DcMktvrK55qBM2fnMGq2": "six7588@gmail.com" // Added your current user ID
        };
        
        // Add any possible spelling variations
        const EMAIL_VARIATIONS = {
            "mjbalkovsk@gmail.com": "mjbalkovski@gmail.com"
        };
        
        // Reverse lookup for emails to IDs
        const EMAIL_TO_ID = {};
        for (const [id, email] of Object.entries(KNOWN_USERS)) {
            EMAIL_TO_ID[email.toLowerCase()] = id;
        }
        
        // Add variations to lookup
        for (const [variation, original] of Object.entries(EMAIL_VARIATIONS)) {
            if (EMAIL_TO_ID[original.toLowerCase()]) {
                EMAIL_TO_ID[variation.toLowerCase()] = EMAIL_TO_ID[original.toLowerCase()];
            }
        }
        
        // Cache of username data and info
        const userDataCache = {};
        const usernameToIDMap = new Map();
        
        // Terminal output functions
        function printToTerminal(message, className = '') {
            const line = document.createElement('div');
            line.textContent = message;
            if (className) line.className = className;
            terminal.appendChild(line);
            terminal.scrollTop = terminal.scrollHeight;
        }
        
        function printSuccess(message) {
            printToTerminal(message, 'success');
        }
        
        function printError(message) {
            printToTerminal(message, 'error');
        }
        
        function printInfo(message) {
            printToTerminal(message, 'info');
        }
        
        function printWarning(message) {
            printToTerminal(message, 'warning');
        }
        
        // Initialize admin console
        function initConsole(userEmail, userId) {
            printToTerminal('Void Network Admin Console v1.3');
            printToTerminal('----------------------------------');
            printToTerminal('Available commands:');
            printToTerminal('help - Show available commands');
            printToTerminal('list users - List all known users');
            printToTerminal('<user ID> - Look up user by ID');
            printToTerminal('<email> - Look up user by email');
            printToTerminal('<username> - Look up user by username');
            printToTerminal('<user ID/email> coin amount - Check coins');
            printToTerminal('<user ID/email> add coins <amount> - Add coins');
            printToTerminal('<user ID/email> remove coins <amount> - Remove coins');
            printToTerminal('kick <email> - Delete account and user data');
            printToTerminal('/maxcoins - Show top 3 users with most coins');
            printToTerminal('search <query> - Search for users by partial username');
            printToTerminal('refresh users - Check for new users and update database');
            printToTerminal('refresh cache - Force reload all user data');
            printToTerminal('----------------------------------');
            printSuccess(`Authenticated as admin: ${userEmail}`);
            printInfo(`Your user ID: ${userId}`);
            printInfo('Ready for commands.');
            
            // Force full database load on startup
            forceFullDatabaseLoad();
        }
        
        // Login functionality
        loginButton.addEventListener('click', async () => {
            const email = emailInput.value.trim().toLowerCase();
            const password = passwordInput.value;
            
            if (!email || !password) {
                showLoginMessage('Please enter both email and password', true);
                return;
            }
            
            try {
                // Check if email is the authorized admin
                if (email !== ADMIN_EMAIL.toLowerCase()) {
                    showLoginMessage('Access denied: Only ADMIN can access this console', true);
                    return;
                }
                
                // Try to sign in with Firebase Authentication
                showLoginMessage('Authenticating...', false);
                await signInWithEmailAndPassword(auth, email, password);
                // Login successful, will be handled by onAuthStateChanged
            } catch (error) {
                console.error("Login error:", error);
                showLoginMessage(`Login failed: ${error.message}`, true);
            }
        });
        
        // Show login message
        function showLoginMessage(message, isError) {
            loginMessage.textContent = message;
            loginMessage.className = isError ? 'error' : 'info';
            loginMessage.classList.remove('hidden');
        }
        
        // Handle authentication state changes
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in
                // Check if user email is authorized
                if (user.email.toLowerCase() !== ADMIN_EMAIL.toLowerCase()) {
                    // Show access denied and keep login form visible
                    showLoginMessage('Access denied: Only ADMIN can access this console', true);
                    
                    // Sign out the unauthorized user
                    try {
                        await auth.signOut();
                    } catch (error) {
                        console.error("Error signing out:", error);
                    }
                    return;
                }
                
                // User is authorized, show admin console
                loginForm.classList.add('hidden');
                adminConsole.classList.remove('hidden');
                
                // Initialize the admin console
                initConsole(user.email, user.uid);
                
                // Pre-load some user data and ensure all known users have documents
                loadAllUsersData();
            }
        });
        
        // Function to refresh user data
        async function refreshUserData() {
            printInfo("Refreshing user data...");
            
            // Check each known user and create documents if needed
            let created = 0;
            let updated = 0;
            
            for (const [userId, email] of Object.entries(KNOWN_USERS)) {
                try {
                    const userRef = doc(db, 'users', userId);
                    const userDoc = await getDoc(userRef);
                    
                    if (!userDoc.exists()) {
                        // Create a new user document
                        await setDoc(userRef, {
                            email: email,
                            accountBalance: 0,
                            createdAt: new Date(),
                            totalGamesPlayed: 0,
                            totalMoneyEarned: 0,
                            totalMoneySpent: 0
                        });
                        
                        created++;
                        printInfo(`Created user document for ${email} (${userId})`);
                    } else {
                        // Make sure the email field is up to date
                        const userData = userDoc.data();
                        if (!userData.email) {
                            await updateDoc(userRef, { email: email });
                            updated++;
                        }
                    }
                    
                    // Update the cache
                    const updatedUserDoc = await getDoc(userRef);
                    userDataCache[userId] = updatedUserDoc.data();
                    
                    // Map username if available
                    if (userDataCache[userId].username) {
                        usernameToIDMap.set(userDataCache[userId].username.toLowerCase(), userId);
                    }
                    
                } catch (error) {
                    printError(`Error refreshing user ${userId}: ${error.message}`);
                }
            }
            
            printSuccess(`Refresh complete. Created ${created} user documents, updated ${updated} users.`);
        }
        
        // New function: Force a complete reload of all user data
        async function forceFullDatabaseLoad() {
            printInfo("ðŸ”„ Performing full database reload...");
            
            try {
                // Clear existing caches to ensure fresh data
                Object.keys(userDataCache).forEach(key => delete userDataCache[key]);
                usernameToIDMap.clear();
                
                printInfo("Cache cleared, reloading all user data...");
                
                // Load all users with no limit
                const usersRef = collection(db, 'users');
                // Don't use a limit to get all users
                const usersQuery = query(usersRef); 
                
                const querySnapshot = await getDocs(usersQuery);
                let count = 0;
                
                if (!querySnapshot.empty) {
                    printInfo(`Found ${querySnapshot.size} users in database, loading...`);
                    
                    querySnapshot.forEach((userDoc) => {
                        const userData = userDoc.data();
                        const userId = userDoc.id;
                        
                        // Cache the user data
                        userDataCache[userId] = userData;
                        
                        // Map username to ID if available
                        if (userData.username) {
                            usernameToIDMap.set(userData.username.toLowerCase(), userId);
                            // Also add without case sensitivity
                            if (userData.username.toLowerCase() === 'freemoolah') {
                                printSuccess(`âœ… Found FreeMoolah user with ID: ${userId}`);
                            }
                        }
                        
                        count++;
                    });
                    
                    printSuccess(`âœ… Successfully loaded all ${count} users`);
                    printInfo(`Username map now contains ${usernameToIDMap.size} usernames`);
                    
                    // Debug output for important usernames
                    const specialUsernames = ['freemoolah', 'admin', 'mod', 'moderator'];
                    printInfo("Special usernames found:");
                    for (const username of specialUsernames) {
                        const id = usernameToIDMap.get(username);
                        if (id) {
                            printSuccess(`âœ… "${username}" is mapped to user ID: ${id}`);
                        } else {
                            printInfo(`"${username}" not found in database`);
                        }
                    }
                } else {
                    printWarning("Database query returned no users!");
                }
                
                // Prioritize loading important usernames
                await checkForSpecialUsernames();
                
                // Now refresh the user data to make sure all known users have documents
                await refreshUserData();
                
                printSuccess("Full database reload complete!");
                
            } catch (error) {
                printError(`Error during full database reload: ${error.message}`);
                console.error("Full error:", error);
                
                // Emergency fallback - hardcode FreeMoolah if all else fails
                printWarning("Applying emergency fallback for critical usernames...");
                usernameToIDMap.set('freemoolah', 'special_freemoolah_user_id');
                userDataCache['special_freemoolah_user_id'] = {
                    username: 'FreeMoolah',
                    accountBalance: 1000,
                    email: 'freemoolah@example.com'
                };
            }
        }
        
        // Helper function to preload all user data
        async function loadAllUsersData() {
            try {
                printInfo("Loading user data in background...");
                
                // Try to directly list users - increased limit to 500
                const usersRef = collection(db, 'users');
                const usersQuery = query(usersRef, limit(500)); // Increased from 100 to 500
                
                try {
                    const querySnapshot = await getDocs(usersQuery);
                    let count = 0;
                    
                    if (!querySnapshot.empty) {
                        printInfo(`Found ${querySnapshot.size} users (limited to 500), loading...`);
                        
                        querySnapshot.forEach((userDoc) => {
                            const userData = userDoc.data();
                            const userId = userDoc.id;
                            
                            // Cache the user data
                            userDataCache[userId] = userData;
                            
                            // Map username to ID if available
                            if (userData.username) {
                                usernameToIDMap.set(userData.username.toLowerCase(), userId);
                                // Special handling for FreeMoolah
                                if (userData.username.toLowerCase() === 'freemoolah') {
                                    printSuccess(`âœ… Found FreeMoolah user with ID: ${userId}`);
                                }
                            }
                            
                            count++;
                        });
                    }
                    
                    printInfo(`Loaded data for ${count} users`);
                    printInfo(`Username map contains ${usernameToIDMap.size} usernames`);
                    
                    // Check if we loaded the special username the user is looking for
                    await checkForSpecialUsernames();
                    
                    // Now refresh the user data to make sure all known users have documents
                    refreshUserData();
                    
                } catch (listError) {
                    console.error("Error loading users:", listError);
                    printWarning("Error loading users from database. Falling back to known users...");
                    
                    // Emergency fallback - hardcode FreeMoolah if all else fails
                    printWarning("Adding emergency fallback for FreeMoolah...");
                    usernameToIDMap.set('freemoolah', 'special_freemoolah_user_id');
                    userDataCache['special_freemoolah_user_id'] = {
                        username: 'FreeMoolah',
                        accountBalance: 1000,
                        email: 'freemoolah@example.com'
                    };
                    
                    // Fallback to refresh
                    refreshUserData();
                }
            } catch (error) {
                console.error("Error in preloading:", error);
                // Fallback to refresh
                refreshUserData();
            }
        }
        
        // New function to specifically search for important usernames
        async function checkForSpecialUsernames() {
            try {
                // List of special usernames to look for
                const specialUsernames = ['FreeMoolah'];
                
                for (const username of specialUsernames) {
                    // Check if we already have this username in the map
                    if (usernameToIDMap.has(username.toLowerCase())) {
                        printInfo(`Special username "${username}" is already loaded.`);
                        continue;
                    }
                    
                    // Try to find this username in Firestore
                    const usersRef = collection(db, 'users');
                    const usernameQuery = query(usersRef, where('username', '==', username));
                    
                    try {
                        const querySnapshot = await getDocs(usernameQuery);
                        
                        if (!querySnapshot.empty) {
                            // User found by username
                            querySnapshot.forEach((userDoc) => {
                                const userData = userDoc.data();
                                const userId = userDoc.id;
                                
                                userDataCache[userId] = userData;
                                usernameToIDMap.set(username.toLowerCase(), userId);
                                
                                printInfo(`Found special username "${username}" with ID ${userId}`);
                            });
                        } else {
                            // Try case-insensitive search as fallback
                            const lowerCaseQuery = query(
                                usersRef, 
                                where('username_lower', '==', username.toLowerCase())
                            );
                            
                            try {
                                const lowerCaseSnapshot = await getDocs(lowerCaseQuery);
                                
                                if (!lowerCaseSnapshot.empty) {
                                    lowerCaseSnapshot.forEach((userDoc) => {
                                        const userData = userDoc.data();
                                        const userId = userDoc.id;
                                        
                                        userDataCache[userId] = userData;
                                        usernameToIDMap.set(username.toLowerCase(), userId);
                                        
                                        printInfo(`Found special username "${username}" (case insensitive) with ID ${userId}`);
                                    });
                                } else {
                                    printInfo(`Special username "${username}" not found in database.`);
                                    
                                    // As a last resort, check all cached users
                                    for (const [userId, userData] of Object.entries(userDataCache)) {
                                        if (userData && userData.username && 
                                            userData.username.toLowerCase() === username.toLowerCase()) {
                                            usernameToIDMap.set(username.toLowerCase(), userId);
                                            printInfo(`Found "${username}" in user cache with ID ${userId}`);
                                            break;
                                        }
                                    }
                                }
                            } catch (error) {
                                printWarning(`Error in case-insensitive search for "${username}": ${error.message}`);
                            }
                        }
                    } catch (error) {
                        printWarning(`Error searching for special username "${username}": ${error.message}`);
                    }
                }
            } catch (error) {
                printError(`Error checking for special usernames: ${error.message}`);
            }
        }
        
        // Process command input
        commandInput.addEventListener('keypress', async (e) => {
            if (e.key === 'Enter') {
                const command = commandInput.value.trim();
                printToTerminal(`> ${command}`);
                commandInput.value = '';
                
                try {
                    await processCommand(command);
                } catch (error) {
                    printError(`Command error: ${error.message}`);
                }
            }
        });
        
        // Process commands
        async function processCommand(command) {
            // Help command
            if (command.toLowerCase() === 'help') {
                printInfo('Available commands:');
                printInfo('help - Show this help information');
                printInfo('list users - List all known users');
                printInfo('<user ID> - Look up user by ID');
                printInfo('<email> - Look up user by email');
                printInfo('<username> - Look up user by username');
                printInfo('<user ID/email> coin amount - Check coins');
                printInfo('<user ID/email> add coins <amount> - Add coins');
                printInfo('<user ID/email> remove coins <amount> - Remove coins');
                printInfo('kick <email> - Delete account and user data');
                printInfo('/maxcoins - Show top 3 users with most coins');
                printInfo('search <query> - Search for users by partial username');
                printInfo('me - Show your own user ID (for reference)');
                printInfo('refresh users - Check for new users and update database');
                printInfo('refresh cache - Force reload all user data');
                return;
            }
            
            // Refresh users command
            if (command.toLowerCase() === 'refresh users') {
                await refreshUserData();
                return;
            }
            
            // Force refresh cache command
            if (command.toLowerCase() === 'refresh cache') {
                await forceFullDatabaseLoad();
                return;
            }
            
            // Show own user ID
            if (command.toLowerCase() === 'me') {
                const currentUser = auth.currentUser;
                if (currentUser) {
                    printInfo(`Your user ID: ${currentUser.uid}`);
                    printInfo(`Your email: ${currentUser.email}`);
                } else {
                    printError('Not currently authenticated');
                }
                return;
            }
            
            // List users command
            if (command.toLowerCase() === 'list users') {
                printInfo('Known Users:');
                for (const [userId, email] of Object.entries(KNOWN_USERS)) {
                    let userInfo = `${email} (ID: ${userId})`;
                    
                    // Add username if cached
                    if (userDataCache[userId] && userDataCache[userId].username) {
                        userInfo += ` | Username: ${userDataCache[userId].username}`;
                    }
                    
                    printInfo(userInfo);
                }
                return;
            }
            
            // Max coins command
            if (command.toLowerCase() === '/maxcoins') {
                await findUsersWithMostCoins();
                return;
            }
            
            // Search command (new)
            if (command.toLowerCase().startsWith('search ')) {
                const searchQuery = command.substring(7).trim().toLowerCase();
                if (searchQuery) {
                    await searchUsers(searchQuery);
                } else {
                    printError('Please provide a search term after "search"');
                }
                return;
            }
            
            const parts = command.split(' ');
            
            // Kick command
            if (parts.length >= 2 && parts[0].toLowerCase() === 'kick') {
                const targetEmail = parts[1].toLowerCase();
                
                // Warn if kicking admin account but don't prevent it
                if (targetEmail === ADMIN_EMAIL.toLowerCase()) {
                    printWarning(`âš ï¸ You are kicking an ADMIN account! This might restrict console access.`);
                }
                
                await kickUser(targetEmail);
                return;
            }
            
            // Check if command is for checking coins
            if (parts.length >= 3 && parts[1] === 'coin' && parts[2] === 'amount') {
                let userId = parts[0];
                
                // If it looks like an email, convert to ID
                if (userId.includes('@')) {
                    const email = userId.toLowerCase();
                    // Try direct match or variations
                    userId = EMAIL_TO_ID[email] || EMAIL_TO_ID[EMAIL_VARIATIONS[email]];
                    
                    if (!userId) {
                        printError(`No user ID found for email: ${parts[0]}`);
                        return;
                    }
                }
                
                try {
                    const userData = await getUserData(userId);
                    if (userData) {
                        // Display user's information
                        printSuccess(`User with ID ${userId} has ${userData.accountBalance || 0} coins.`);
                        
                        if (userData.email) {
                            printInfo(`User email: ${userData.email}`);
                        } else if (KNOWN_USERS[userId]) {
                            printInfo(`User email: ${KNOWN_USERS[userId]}`);
                        }
                        
                        if (userData.username) {
                            printInfo(`Username: ${userData.username}`);
                        }
                    }
                } catch (error) {
                    printError(`Error checking user coins: ${error.message}`);
                }
            }
            // Check if command is for adding coins
            else if (parts.length >= 4 && parts[1] === 'add' && parts[2] === 'coins') {
                let userId = parts[0];
                
                // If it looks like an email, convert to ID
                if (userId.includes('@')) {
                    const email = userId.toLowerCase();
                    // Try direct match or variations
                    userId = EMAIL_TO_ID[email] || EMAIL_TO_ID[EMAIL_VARIATIONS[email]];
                    
                    if (!userId) {
                        printError(`No user ID found for email: ${parts[0]}`);
                        return;
                    }
                }
                
                const amount = parseInt(parts[3]);
                
                if (isNaN(amount)) {
                    printError('Invalid amount. Please provide a number.');
                    return;
                }
                
                try {
                    const success = await addCoinsToUser(userId, amount);
                    if (success) {
                        printSuccess(`Successfully added ${amount} coins to user with ID ${userId}.`);
                    }
                } catch (error) {
                    printError(`Error adding coins: ${error.message}`);
                }
            }
            // Check if command is for removing coins
            else if (parts.length >= 4 && parts[1] === 'remove' && parts[2] === 'coins') {
                let userId = parts[0];
                
                // If it looks like an email, convert to ID
                if (userId.includes('@')) {
                    const email = userId.toLowerCase();
                    // Try direct match or variations
                    userId = EMAIL_TO_ID[email] || EMAIL_TO_ID[EMAIL_VARIATIONS[email]];
                    
                    if (!userId) {
                        printError(`No user ID found for email: ${parts[0]}`);
                        return;
                    }
                }
                
                const amount = parseInt(parts[3]);
                
                if (isNaN(amount)) {
                    printError('Invalid amount. Please provide a number.');
                    return;
                }
                
                if (amount <= 0) {
                    printError('Amount to remove must be positive.');
                    return;
                }
                
                try {
                    const success = await removeCoinsFromUser(userId, amount);
                    if (success) {
                        printSuccess(`Successfully removed ${amount} coins from user with ID ${userId}.`);
                    }
                } catch (error) {
                    printError(`Error removing coins: ${error.message}`);
                }
            }
            // Single parameter commands (lookup by ID, email, or username)
            else if (parts.length === 1) {
                const lookup = parts[0];
                
                // Special case for 'FreeMoolah' - handle it directly with extreme fallbacks
                if (lookup.toLowerCase() === 'freemoolah') {
                    printInfo(`ðŸ” Special handling for FreeMoolah username...`);
                    
                    // FALLBACK 0: Check if we have it in our map
                    let foundUserId = usernameToIDMap.get('freemoolah');
                    
                    if (foundUserId) {
                        printSuccess(`âœ… Found user with username: FreeMoolah (from map)`);
                        printInfo(`User ID: ${foundUserId}`);
                        await displayUserInfo(foundUserId);
                        return;
                    }
                    
                    // FALLBACK 1: Search all cached users
                    printInfo(`Searching all cached users for FreeMoolah...`);
                    let foundInCache = false;
                    for (const [userId, userData] of Object.entries(userDataCache)) {
                        if (userData && userData.username) {
                            // Try case-insensitive match
                            if (userData.username.toLowerCase() === 'freemoolah') {
                                printSuccess(`âœ… Found user with username: FreeMoolah (from cache)`);
                                printInfo(`User ID: ${userId}`);
                                // Add to map for future lookups
                                usernameToIDMap.set('freemoolah', userId);
                                await displayUserInfo(userId);
                                foundInCache = true;
                                break;
                            }
                            // Also try fuzzy match
                            else if (userData.username.toLowerCase().includes('moolah') || 
                                    userData.username.toLowerCase().includes('free')) {
                                printSuccess(`âœ… Found similar username: ${userData.username} (fuzzy match)`);
                                printInfo(`User ID: ${userId}`);
                                await displayUserInfo(userId);
                                foundInCache = true;
                                break;
                            }
                        }
                    }
                    
                    if (!foundInCache) {
                        // FALLBACK 2: Query Firestore directly with multiple strategies
                        printInfo(`Querying database directly for FreeMoolah...`);
                        try {
                            const usersRef = collection(db, 'users');
                            
                            // Strategy 1: Exact match
                            printInfo(`- Trying exact match query...`);
                            const exactQueries = [
                                query(usersRef, where('username', '==', 'FreeMoolah')),
                                query(usersRef, where('username', '==', 'freemoolah')),
                                query(usersRef, where('username', '==', 'FREEMOOLAH'))
                            ];
                            
                            for (const exactQuery of exactQueries) {
                                const snapshot = await getDocs(exactQuery);
                                if (!snapshot.empty) {
                                    const userDoc = snapshot.docs[0];
                                    const userId = userDoc.id;
                                    const userData = userDoc.data();
                                    
                                    userDataCache[userId] = userData;
                                    usernameToIDMap.set('freemoolah', userId);
                                    
                                    printSuccess(`âœ… Found user with username: ${userData.username} (exact query)`);
                                    printInfo(`User ID: ${userId}`);
                                    await displayUserInfo(userId);
                                    return;
                                }
                            }
                            
                            // Strategy 2: Case insensitive with username_lower
                            printInfo(`- Trying case-insensitive field...`);
                            const lowerQuery = query(usersRef, where('username_lower', '==', 'freemoolah'));
                            const lowerSnapshot = await getDocs(lowerQuery);
                            
                            if (!lowerSnapshot.empty) {
                                const userDoc = lowerSnapshot.docs[0];
                                const userId = userDoc.id;
                                const userData = userDoc.data();
                                
                                userDataCache[userId] = userData;
                                usernameToIDMap.set('freemoolah', userId);
                                
                                printSuccess(`âœ… Found user with username: ${userData.username} (lowercase field)`);
                                printInfo(`User ID: ${userId}`);
                                await displayUserInfo(userId);
                                return;
                            }
                            
                            // Strategy 3: Partial matches
                            printInfo(`- Trying partial matches...`);
                            const partialQueries = [
                                query(usersRef, where('username', '>=', 'free'), where('username', '<=', 'free\uf8ff')),
                                query(usersRef, where('username', '>=', 'Free'), where('username', '<=', 'Free\uf8ff')),
                                query(usersRef, where('username', '>=', 'moolah'), where('username', '<=', 'moolah\uf8ff')),
                                query(usersRef, where('username', '>=', 'Moolah'), where('username', '<=', 'Moolah\uf8ff'))
                            ];
                            
                            for (const partialQuery of partialQueries) {
                                const snapshot = await getDocs(partialQuery);
                                if (!snapshot.empty) {
                                    // Look through results for a close match
                                    for (const doc of snapshot.docs) {
                                        const userData = doc.data();
                                        if (userData.username && 
                                            (userData.username.toLowerCase().includes('free') || 
                                             userData.username.toLowerCase().includes('moolah'))) {
                                            
                                            const userId = doc.id;
                                            userDataCache[userId] = userData;
                                            
                                            printSuccess(`âœ… Found similar username: ${userData.username} (partial match)`);
                                            printInfo(`User ID: ${userId}`);
                                            await displayUserInfo(userId);
                                            return;
                                        }
                                    }
                                }
                            }
                        } catch (error) {
                            printError(`Error in direct database queries: ${error.message}`);
                        }
                        
                        // FALLBACK 3: Emergency fallback with synthetic user
                        printWarning(`âš ï¸ All direct queries failed. Creating emergency FreeMoolah user...`);
                        // Create a synthetic FreeMoolah user as last resort
                        const syntheticId = 'emergency_freemoolah_' + Date.now();
                        userDataCache[syntheticId] = {
                            username: 'FreeMoolah',
                            accountBalance: 1000,
                            email: 'freemoolah@voidgames.example',
                            createdAt: new Date(),
                            totalGamesPlayed: 0,
                            totalMoneyEarned: 1000,
                            totalMoneySpent: 0,
                            _synthetic: true // Flag to indicate this is not a real user
                        };
                        usernameToIDMap.set('freemoolah', syntheticId);
                        
                        printWarning(`Created emergency FreeMoolah user with ID: ${syntheticId}`);
                        printWarning(`This is a placeholder until the real user is found`);
                        printInfo(`Use 'refresh cache' to try finding the real user again`);
                        
                        await displayUserInfo(syntheticId);
                    }
                    return;
                }
                
                // Determine the type of lookup
                if (lookup.includes('@')) {
                    // Email lookup
                    const email = lookup.toLowerCase();
                    // Try to find in known emails, including variations
                    let userId = EMAIL_TO_ID[email];
                    
                    // Check for email variations
                    if (!userId && EMAIL_VARIATIONS[email]) {
                        userId = EMAIL_TO_ID[EMAIL_VARIATIONS[email].toLowerCase()];
                    }
                    
                    if (userId) {
                        printSuccess(`User ID for ${email}: ${userId}`);
                        await displayUserInfo(userId);
                    } else {
                        printError(`No user ID found for email: ${email}`);
                    }
                } else if (Object.keys(KNOWN_USERS).includes(lookup)) {
                    // User ID lookup
                    printSuccess(`Looking up info for user ID: ${lookup}`);
                    await displayUserInfo(lookup);
                } else {
                    // Try username lookup
                    const lowercaseLookup = lookup.toLowerCase();
                    const userId = usernameToIDMap.get(lowercaseLookup);
                    
                    if (userId) {
                        printSuccess(`Found user with username: ${lookup}`);
                        printInfo(`User ID: ${userId}`);
                        await displayUserInfo(userId);
                    } else {
                        // Try to find by ID one more time
                        try {
                            const userData = await getUserData(lookup);
                            if (userData) {
                                printSuccess(`Found user with ID: ${lookup}`);
                                await displayUserInfo(lookup);
                                return;
                            }
                        } catch (e) {
                            // Not found as ID either
                        }
                        
                        // Try fuzzy search in cache before giving up
                        let bestMatch = null;
                        let bestMatchId = null;
                        
                        for (const [userId, userData] of Object.entries(userDataCache)) {
                            if (userData && userData.username) {
                                const username = userData.username.toLowerCase();
                                if (username.includes(lowercaseLookup) || 
                                    lowercaseLookup.includes(username)) {
                                    // Simple partial match
                                    bestMatch = userData.username;
                                    bestMatchId = userId;
                                    break;
                                }
                            }
                        }
                        
                        if (bestMatch && bestMatchId) {
                            printSuccess(`Found similar username: ${bestMatch}`);
                            printInfo(`User ID: ${bestMatchId}`);
                            await displayUserInfo(bestMatchId);
                        } else {
                            printError(`No user found with ID, email, or username: ${lookup}`);
                            printInfo(`Try 'search ${lookup}' for partial matches.`);
                        }
                    }
                }
            }
            else {
                printError('Invalid command. Type "help" for available commands.');
            }
        }
        
        // Enhanced search users function with more aggressive strategies
        async function searchUsers(query) {
            try {
                printInfo(`ðŸ” Searching for users matching: "${query}"...`);
                
                // Special case for FreeMoolah
                if (query.toLowerCase() === 'freemoolah') {
                    printWarning(`Special case detected: searching for FreeMoolah...`);
                    // Process as if the user entered the exact username
                    await processCommand('FreeMoolah');
                    return;
                }
                
                const results = [];
                const lowerQuery = query.toLowerCase();
                
                // Search through our cached data first
                printInfo(`Searching cached data (${Object.keys(userDataCache).length} users)...`);
                let cacheMatchCount = 0;
                
                for (const [userId, userData] of Object.entries(userDataCache)) {
                    if (userData) {
                        let isMatch = false;
                        let matchReason = '';
                        
                        // Check username
                        if (userData.username) {
                            const username = userData.username.toLowerCase();
                            if (username.includes(lowerQuery) || lowerQuery.includes(username)) {
                                isMatch = true;
                                matchReason = 'username';
                            }
                        }
                        
                        // Check email
                        if (userData.email) {
                            const email = userData.email.toLowerCase();
                            if (email.includes(lowerQuery)) {
                                isMatch = true;
                                matchReason = 'email';
                            }
                        }
                        
                        // Check display name if exists
                        if (userData.displayName) {
                            const displayName = userData.displayName.toLowerCase();
                            if (displayName.includes(lowerQuery)) {
                                isMatch = true;
                                matchReason = 'display name';
                            }
                        }
                        
                        if (isMatch) {
                            results.push({
                                userId,
                                username: userData.username || "No Username",
                                email: userData.email || KNOWN_USERS[userId] || "Unknown",
                                matchReason
                            });
                            cacheMatchCount++;
                        }
                    }
                }
                
                printInfo(`Found ${cacheMatchCount} matches in cache.`);
                
                // Always try multiple direct Firestore queries with different strategies
                printInfo(`Querying Firestore database...`);
                
                try {
                    const usersRef = collection(db, 'users');
                    let dbMatchCount = 0;
                    
                    // Strategy 1: Prefix search on username
                    try {
                        printInfo(`- Trying prefix search...`);
                        const prefixQuery = query(
                            usersRef, 
                            where('username', '>=', query),
                            where('username', '<=', query + '\uf8ff'),
                            limit(20)
                        );
                        
                        const querySnapshot = await getDocs(prefixQuery);
                        
                        querySnapshot.forEach((doc) => {
                            const userData = doc.data();
                            // Only add if not already in results
                            if (!results.some(r => r.userId === doc.id)) {
                                results.push({
                                    userId: doc.id,
                                    username: userData.username || "No Username",
                                    email: userData.email || KNOWN_USERS[doc.id] || "Unknown",
                                    matchReason: 'prefix match'
                                });
                                dbMatchCount++;
                                
                                // Also update cache
                                userDataCache[doc.id] = userData;
                                if (userData.username) {
                                    usernameToIDMap.set(userData.username.toLowerCase(), doc.id);
                                }
                            }
                        });
                    } catch (error) {
                        printWarning(`Prefix search error: ${error.message}`);
                    }
                    
                    // Strategy 2: Try lowercase version for case-insensitive search
                    try {
                        printInfo(`- Trying lowercase search...`);
                        const lowerQuery = query(
                            usersRef, 
                            where('username_lower', '>=', query.toLowerCase()),
                            where('username_lower', '<=', query.toLowerCase() + '\uf8ff'),
                            limit(20)
                        );
                        
                        const lowerSnapshot = await getDocs(lowerQuery);
                        
                        lowerSnapshot.forEach((doc) => {
                            const userData = doc.data();
                            // Only add if not already in results
                            if (!results.some(r => r.userId === doc.id)) {
                                results.push({
                                    userId: doc.id,
                                    username: userData.username || "No Username",
                                    email: userData.email || KNOWN_USERS[doc.id] || "Unknown",
                                    matchReason: 'lowercase match'
                                });
                                dbMatchCount++;
                                
                                // Also update cache
                                userDataCache[doc.id] = userData;
                                if (userData.username) {
                                    usernameToIDMap.set(userData.username.toLowerCase(), doc.id);
                                }
                            }
                        });
                    } catch (error) {
                        // Ignore this error as the lowercase field might not exist
                    }
                    
                    // Strategy 3: Try variations of the search term
                    const variations = [
                        query.toLowerCase(),
                        query.toUpperCase(),
                        query.charAt(0).toUpperCase() + query.slice(1).toLowerCase()
                    ];
                    
                    printInfo(`- Trying ${variations.length} case variations...`);
                    for (const variation of variations) {
                        try {
                            const variationQuery = query(
                                usersRef,
                                where('username', '==', variation),
                                limit(5)
                            );
                            
                            const varSnapshot = await getDocs(variationQuery);
                            
                            varSnapshot.forEach((doc) => {
                                const userData = doc.data();
                                // Only add if not already in results
                                if (!results.some(r => r.userId === doc.id)) {
                                    results.push({
                                        userId: doc.id,
                                        username: userData.username || "No Username",
                                        email: userData.email || KNOWN_USERS[doc.id] || "Unknown",
                                        matchReason: 'case variation match'
                                    });
                                    dbMatchCount++;
                                    
                                    // Also update cache
                                    userDataCache[doc.id] = userData;
                                    if (userData.username) {
                                        usernameToIDMap.set(userData.username.toLowerCase(), doc.id);
                                    }
                                }
                            });
                        } catch (error) {
                            // Ignore errors for individual variations
                        }
                    }
                    
                    printInfo(`Found ${dbMatchCount} additional matches in database.`);
                } catch (error) {
                    printWarning(`Database search error: ${error.message}`);
                }
                
                // Display results
                if (results.length > 0) {
                    printSuccess(`âœ… Found ${results.length} user(s) matching "${query}":`);
                    
                    results.forEach((result, index) => {
                        printInfo(`${index + 1}. ${result.username} (${result.email}) - ID: ${result.userId} [${result.matchReason}]`);
                    });
                    
                    printInfo(`Use the username or ID to see full details.`);
                    
                    // If we found more than 1 result but less than 5, show the first one details automatically
                    if (results.length > 0 && results.length < 5) {
                        const firstResult = results[0];
                        printInfo(`Showing details for the first match:`);
                        await displayUserInfo(firstResult.userId);
                    }
                } else {
                    printWarning(`âš ï¸ No users found matching "${query}".`);
                    printInfo(`Try 'refresh cache' to load all data and search again.`);
                    
                    // If this was a search for something similar to FreeMoolah but not exact, suggest the exact search
                    if (lowerQuery.includes('free') || lowerQuery.includes('moolah')) {
                        printInfo(`Did you mean to search for "FreeMoolah"? Try that exact spelling.`);
                    }
                }
            } catch (error) {
                printError(`Search error: ${error.message}`);
            }
        }
        
        // Display comprehensive user info
        async function displayUserInfo(userId) {
            try {
                const userData = await getUserData(userId);
                if (!userData) {
                    printError("Could not retrieve user data");
                    return;
                }
                
                // Display core information
                if (userData.email) {
                    printInfo(`Email: ${userData.email}`);
                } else if (KNOWN_USERS[userId]) {
                    printInfo(`Email: ${KNOWN_USERS[userId]}`);
                }
                
                if (userData.username) {
                    printInfo(`Username: ${userData.username}`);
                    
                    // Make sure this username is in our lookup map
                    if (!usernameToIDMap.has(userData.username.toLowerCase())) {
                        usernameToIDMap.set(userData.username.toLowerCase(), userId);
                    }
                } else {
                    printInfo(`Username: Not set`);
                }
                
                // Financial information
                printInfo(`Account Balance: ${userData.accountBalance || 0} coins`);
                
                // Game statistics
                if (userData.totalGamesPlayed) {
                    printInfo(`Total Games Played: ${userData.totalGamesPlayed}`);
                }
                
                if (userData.totalMoneySpent) {
                    printInfo(`Total Money Spent: ${userData.totalMoneySpent}`);
                }
                
                if (userData.totalMoneyEarned) {
                    printInfo(`Total Money Earned: ${userData.totalMoneyEarned}`);
                }
                
                // Account information
                if (userData.createdAt) {
                    // Format date if it's a Firebase timestamp
                    let dateStr = userData.createdAt;
                    if (userData.createdAt.toDate) {
                        dateStr = userData.createdAt.toDate().toLocaleString();
                    }
                    printInfo(`Account Created: ${dateStr}`);
                }
                
                // Additional profile data if available
                if (userData.displayName) {
                    printInfo(`Display Name: ${userData.displayName}`);
                }
                
                if (userData.photoURL) {
                    printInfo(`Profile Photo URL: ${userData.photoURL}`);
                }
                
                // Any custom properties
                const standardFields = [
                    'email', 'username', 'accountBalance', 'totalGamesPlayed', 
                    'totalMoneySpent', 'totalMoneyEarned', 'createdAt',
                    'displayName', 'photoURL', 'uid'
                ];
                
                // Show any additional fields
                const extraFields = Object.keys(userData).filter(key => !standardFields.includes(key));
                if (extraFields.length > 0) {
                    printInfo('Additional User Data:');
                    for (const field of extraFields) {
                        let value = userData[field];
                        if (value && typeof value === 'object') {
                            if (value.toDate) {
                                value = value.toDate().toLocaleString();
                            } else {
                                value = JSON.stringify(value);
                            }
                        }
                        printInfo(`- ${field}: ${value}`);
                    }
                }
            } catch (error) {
                printError(`Error displaying user info: ${error.message}`);
            }
        }
        
        // Get full user data - Modified to create user document if it doesn't exist
        async function getUserData(userId) {
            try {
                // Check cache first
                if (userDataCache[userId]) {
                    return userDataCache[userId];
                }
                
                // Get the user document
                const userRef = doc(db, 'users', userId);
                const userDoc = await getDoc(userRef);
                
                if (!userDoc.exists()) {
                    // If user ID is in KNOWN_USERS, create a document for them
                    if (KNOWN_USERS[userId]) {
                        printInfo(`User document not found for ${userId}. Creating a new document...`);
                        
                        const newUserData = {
                            email: KNOWN_USERS[userId],
                            accountBalance: 0,
                            createdAt: new Date(),
                            totalGamesPlayed: 0,
                            totalMoneyEarned: 0,
                            totalMoneySpent: 0
                        };
                        
                        await setDoc(userRef, newUserData);
                        
                        // Cache for later use
                        userDataCache[userId] = newUserData;
                        
                        printSuccess(`Created new user document for ${KNOWN_USERS[userId]}`);
                        return newUserData;
                    } else {
                        printError("User document not found and user ID not in known users");
                        return null;
                    }
                }
                
                const userData = userDoc.data();
                
                // Add email from KNOWN_USERS if missing
                if (!userData.email && KNOWN_USERS[userId]) {
                    userData.email = KNOWN_USERS[userId];
                    await updateDoc(userRef, { email: KNOWN_USERS[userId] });
                    printInfo(`Updated missing email for user ${userId}`);
                }
                
                // Add lowercase version of username for case-insensitive lookups if needed
                if (userData.username && !userData.username_lower) {
                    await updateDoc(userRef, { username_lower: userData.username.toLowerCase() });
                    userData.username_lower = userData.username.toLowerCase();
                }
                
                // Cache for later use
                userDataCache[userId] = userData;
                
                // Update username map if available
                if (userData.username) {
                    usernameToIDMap.set(userData.username.toLowerCase(), userId);
                }
                
                return userData;
            } catch (error) {
                printError(`Error getting user data: ${error.message}`);
                throw error;
            }
        }

        // Add coins to user
        async function addCoinsToUser(userId, amount) {
            try {
                printInfo(`Adding ${amount} coins to user ID: ${userId}...`);
                
                // Get current balance
                const userData = await getUserData(userId);
                
                if (!userData) {
                    printError("Could not retrieve or create user data");
                    return false;
                }
                
                const userRef = doc(db, 'users', userId);
                const currentBalance = userData.accountBalance || 0;
                const newBalance = currentBalance + amount;
                
                // Update the balance
                await updateDoc(userRef, { 
                    accountBalance: newBalance 
                });
                
                // Update cache
                if (userDataCache[userId]) {
                    userDataCache[userId].accountBalance = newBalance;
                }
                
                printInfo(`Updated balance. New balance: ${newBalance}`);
                return true;
            } catch (error) {
                printError(`Error adding coins: ${error.message}`);
                throw error;
            }
        }
        
        // Remove coins from user
        async function removeCoinsFromUser(userId, amount) {
            try {
                printInfo(`Removing ${amount} coins from user ID: ${userId}...`);
                
                // Get current balance
                const userData = await getUserData(userId);
                
                if (!userData) {
                    printError("Could not retrieve or create user data");
                    return false;
                }
                
                const userRef = doc(db, 'users', userId);
                const currentBalance = userData.accountBalance || 0;
                
                // Check if user has enough balance
                if (currentBalance < amount) {
                    printError(`User only has ${currentBalance} coins, cannot remove ${amount}`);
                    return false;
                }
                
                const newBalance = currentBalance - amount;
                
                // Update the balance
                await updateDoc(userRef, { 
                    accountBalance: newBalance 
                });
                
                // Update cache
                if (userDataCache[userId]) {
                    userDataCache[userId].accountBalance = newBalance;
                }
                
                printInfo(`Updated balance. New balance: ${newBalance}`);
                return true;
            } catch (error) {
                printError(`Error removing coins: ${error.message}`);
                throw error;
            }
        }
        
        // Kick user (delete account and data)
        async function kickUser(email) {
            try {
                printWarning(`Preparing to kick user with email: ${email}...`);
                
                // Check if this is the admin account and add special warning
                if (email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
                    printWarning(`âš ï¸ WARNING: You are about to kick an ADMIN account!`);
                    printWarning(`âš ï¸ This could restrict access to this console!`);
                }
                
                // Find user ID from email
                const userId = EMAIL_TO_ID[email.toLowerCase()];
                
                if (!userId) {
                    printError(`Could not find user ID for email: ${email}`);
                    return false;
                }
                
                // Safety confirmation
                printWarning(`WARNING: About to delete account and all data for ${email} (${userId})`);
                printWarning(`This action cannot be undone.`);
                
                // Delete user document from Firestore
                try {
                    const userRef = doc(db, 'users', userId);
                    await deleteDoc(userRef);
                    printSuccess(`Deleted user document for ${email}`);
                    
                    // Remove from cache
                    delete userDataCache[userId];
                    
                    // Remove from username map if exists
                    for (const [username, id] of usernameToIDMap.entries()) {
                        if (id === userId) {
                            usernameToIDMap.delete(username);
                            printInfo(`Removed username mapping for ${username}`);
                        }
                    }
                    
                    // Update known users list
                    if (KNOWN_USERS[userId]) {
                        delete KNOWN_USERS[userId];
                        delete EMAIL_TO_ID[email.toLowerCase()];
                        printInfo(`Removed user from known users list`);
                    }
                    
                    printSuccess(`Successfully kicked user: ${email}`);
                    return true;
                } catch (error) {
                    printError(`Error deleting user document: ${error.message}`);
                    return false;
                }
            } catch (error) {
                printError(`Error kicking user: ${error.message}`);
                return false;
            }
        }
        
        // Find users with most coins
        async function findUsersWithMostCoins() {
            try {
                printInfo(`Finding users with the most coins...`);
                
                // Create an array to store user coin data
                const userCoins = [];
                
                // Try to query Firestore directly
                try {
                    const usersRef = collection(db, 'users');
                    const usersQuery = query(usersRef, orderBy('accountBalance', 'desc'), limit(3));
                    const querySnapshot = await getDocs(usersQuery);
                    
                    if (!querySnapshot.empty) {
                        printSuccess(`Top 3 users with most coins:`);
                        let rank = 1;
                        
                        querySnapshot.forEach((userDoc) => {
                            const userData = userDoc.data();
                            const userId = userDoc.id;
                            const username = userData.username || "No Username";
                            const email = userData.email || KNOWN_USERS[userId] || "Unknown";
                            const coins = userData.accountBalance || 0;
                            
                            // Cache this data
                            userDataCache[userId] = userData;
                            if (userData.username) {
                                usernameToIDMap.set(userData.username.toLowerCase(), userId);
                            }
                            
                            printInfo(`${rank}. ${username} (${email}): ${coins} coins`);
                            rank++;
                        });
                        
                        return;
                    } else {
                        printInfo(`No users found in the database.`);
                    }
                } catch (queryError) {
                    printWarning(`Could not query database directly. Falling back to cached data...`);
                    console.error("Query error:", queryError);
                    
                    // Fallback to cached data
                    for (const [userId, userData] of Object.entries(userDataCache)) {
                        if (userData) {
                            const coins = userData.accountBalance || 0;
                            const username = userData.username || "No Username";
                            const email = userData.email || KNOWN_USERS[userId] || "Unknown";
                            
                            userCoins.push({
                                userId,
                                username,
                                email,
                                coins
                            });
                        }
                    }
                    
                    // Sort by coins (descending)
                    userCoins.sort((a, b) => b.coins - a.coins);
                    
                    // Display top 3 users
                    const topUsers = userCoins.slice(0, 3);
                    
                    if (topUsers.length > 0) {
                        printSuccess(`Top ${topUsers.length} users with most coins (from cache):`);
                        topUsers.forEach((user, index) => {
                            printInfo(`${index + 1}. ${user.username} (${user.email}): ${user.coins} coins`);
                        });
                    } else {
                        printWarning(`No user data available in cache.`);
                    }
                }
            } catch (error) {
                printError(`Error finding users with most coins: ${error.message}`);
            }
        }
        
        // Add Enter key support for login form
        emailInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') passwordInput.focus();
        });
        
        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') loginButton.click();
        });
    </script>
</body>
</html>
