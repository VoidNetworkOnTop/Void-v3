<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Void Network Games</title>
    <link rel="shortcut icon" href="./assets/favicon.png" type="image/png">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background: #000;
            color: #fff;
            font-family: 'Arial', sans-serif;
            overflow-x: hidden;
        }

        /* Theme Background Container - with fixed positioning and proper z-index */
        #theme-background {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 9999; /* Very high z-index to be on top of everything */
            opacity: 0;
            transition: opacity 1s ease;
            pointer-events: none; /* So clicks pass through to elements below */
            display: none; /* Hidden by default */
        }

        #theme-background.active {
            opacity: 0.6; /* Semi-transparent */
            display: block; /* Show when active */
        }

        .header-container {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 1rem;
            position: absolute;
            top: 0;
            right: 0;
            z-index: 1000;
            gap: 15px;
        }

        #profile-icon, #shop-icon {
            cursor: pointer;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s ease, transform 0.3s ease;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
        }

        #profile-icon:hover, #shop-icon:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
        }

        #profile-icon svg, #shop-icon svg {
            width: 24px;
            height: 24px;
            fill: #fff;
        }

        #auth-container, #shop-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
            padding: 30px;
            width: 350px;
            max-width: 90%;
            z-index: 1000;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: none;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            box-shadow: 
                0 0 2px #fff,
                0 0 4px #fff,
                0 0 8px rgba(255, 255, 255, 0.5),
                inset 0 0 2px rgba(255, 255, 255, 0.2);
        }

        #auth-container.visible, #shop-container.visible {
            opacity: 1;
        }

        #auth-container input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        #auth-container input:focus {
            outline: none;
            border-color: #4a4a4a;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
        }

        #auth-container button, #shop-container button {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        #auth-container button:hover, #shop-container button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        #user-profile {
            text-align: center;
            margin-bottom: 15px;
        }

        #user-profile h3 {
            margin-bottom: 10px;
            color: #fff;
        }

        /* Improved Shop Container Styles */
        #shop-container {
            width: 800px;
            max-height: 85vh;
            padding: 0;
            backdrop-filter: blur(15px);
            box-shadow: 
                0 0 2px #fff,
                0 0 4px #fff,
                0 0 8px rgba(255, 255, 255, 0.5),
                inset 0 0 2px rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
            overflow: hidden; /* Hide the default scrollbar */
            display: flex;
            flex-direction: column;
        }

        .shop-header {
            padding: 25px;
            background: rgba(0, 0, 0, 0.7);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px 10px 0 0;
            position: relative;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .shop-title {
            font-size: 1.8rem;
            margin: 0;
            color: #fff;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
            background: linear-gradient(45deg, #fff, #a0a0a0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: bold;
        }

        .shop-balance {
            margin-top: 8px;
            color: #FFD700;
            font-size: 1rem;
            text-align: center;
            font-weight: bold;
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.3);
        }

        .shop-items-container {
            overflow-y: auto;
            max-height: calc(85vh - 80px); /* Account for header height */
            background: rgba(0, 0, 0, 0.5);
        }

        /* Custom scrollbar styling */
        .shop-items-container::-webkit-scrollbar {
            width: 8px;
        }

        .shop-items-container::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            margin: 4px;
        }

        .shop-items-container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .shop-items-container::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .shop-items {
            padding: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 30px;
        }

        .shop-category {
            margin: 20px 30px 15px;
            font-size: 1.3rem;
            color: #fff;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            grid-column: 1 / -1;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 300;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.3);
        }

        .shop-item {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            position: relative;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .shop-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4), 0 0 5px rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .shop-item-image {
            width: 100%;
            height: 200px;
            overflow: hidden;
            position: relative;
        }

        .shop-item-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }

        .shop-item:hover .shop-item-image img {
            transform: scale(1.05);
        }

        .shop-item-details {
            padding: 20px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .shop-item-title {
            font-size: 1.3rem;
            color: #fff;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .shop-item-description {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 15px;
            line-height: 1.4;
            flex-grow: 1;
        }

        .shop-item-price {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .price-amount {
            color: #FFD700;
            font-weight: bold;
            font-size: 1.1rem;
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.3);
        }

        .buy-button {
            background: rgba(0, 255, 0, 0.2);
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            font-weight: bold;
            letter-spacing: 1px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(5px);
        }

        .buy-button:hover {
            background: rgba(0, 255, 0, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3), 0 0 5px rgba(0, 255, 0, 0.3);
        }

        .buy-button:disabled {
            background: rgba(255, 0, 0, 0.2);
            cursor: not-allowed;
            opacity: 0.7;
            transform: none;
            box-shadow: none;
        }

        .buy-button.equip {
            background: rgba(0, 150, 255, 0.3);
        }

        .buy-button.equip:hover {
            background: rgba(0, 150, 255, 0.4);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3), 0 0 5px rgba(0, 150, 255, 0.3);
        }

        .buy-button.unequip {
            background: rgba(255, 150, 0, 0.3);
        }

        .buy-button.unequip:hover {
            background: rgba(255, 150, 0, 0.4);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3), 0 0 5px rgba(255, 150, 0, 0.3);
        }

        .shop-item.owned::before {
            content: 'OWNED';
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0, 255, 0, 0.3);
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 0.8rem;
            font-weight: bold;
            z-index: 1;
            box-shadow: 0 0 5px rgba(0, 255, 0, 0.3);
        }

        .shop-item.equipped::before {
            content: 'EQUIPPED';
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 215, 0, 0.4);
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 0.8rem;
            font-weight: bold;
            z-index: 1;
            box-shadow: 0 0 5px rgba(255, 215, 0, 0.4);
        }

        .shop-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.8rem;
            cursor: pointer;
            transition: color 0.3s ease, transform 0.3s ease;
            width: auto !important;
            padding: 0 !important;
            margin: 0 !important;
            line-height: 1;
            z-index: 2;
        }

        .shop-close:hover {
            color: rgba(255, 255, 255, 1);
            background: none !important;
            transform: scale(1.1);
        }

        /* Leaderboard Container Styles */
        .leaderboard-container {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 25%; /* Take up 25% of screen width */
            z-index: 2;
            pointer-events: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .leaderboard-box {
            background: #000;
            border-radius: 10px;
            padding: 2px;
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 
                0 0 2px #fff,
                0 0 4px #fff,
                0 0 6px #fff,
                0 0 8px #fff,
                inset 0 0 2px rgba(255, 255, 255, 0.2);
            overflow: hidden;
            height: 100%;
        }

        .leaderboard-box::before {
            content: '';
            position: absolute;
            inset: -1px;
            background: #fff;
            border-radius: 10px;
            z-index: -1;
            box-shadow: 
                0 0 15px #fff,
                0 0 30px rgba(255, 255, 255, 0.8),
                0 0 40px rgba(255, 255, 255, 0.6),
                0 0 50px rgba(255, 255, 255, 0.4);
            opacity: 0.5;
        }

        .leaderboard-title {
            padding: 15px 10px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 1.3rem;
            background: linear-gradient(45deg, #fff, #a0a0a0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .leaderboard-toggle {
            display: none;
            margin-left: 10px;
            cursor: pointer;
            font-size: 1rem;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            justify-content: center;
            align-items: center;
        }

        .leaderboard-list {
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow-y: auto;
            flex-grow: 1;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .leaderboard-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(2px);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .leaderboard-rank {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.7);
            font-weight: bold;
            margin-right: 8px;
            min-width: 25px;
            flex-shrink: 0;
        }

        .leaderboard-username-container {
            flex: 1;
            min-width: 0; /* Critical for text-overflow to work properly */
            max-width: 60%; /* Ensure username takes at most 60% of space */
            overflow: hidden;
        }

        .leaderboard-username {
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block;
            width: 100%;
        }

        .leaderboard-balance {
            font-size: 0.9rem;
            color: #FFD700;
            font-weight: bold;
            margin-left: 10px;
            text-align: right;
            min-width: 80px; /* Ensures minimum width for balance */
            flex-shrink: 0;
        }

        .leaderboard-loading {
            text-align: center;
            color: rgba(255, 255, 255, 0.5);
            padding: 20px 0;
        }

        .leaderboard-updated {
            animation: leaderboard-pulse 1s ease;
        }

        .leaderboard-error {
            text-align: center;
            color: #ff6b6b;
            padding: 20px 0;
        }

        .leaderboard-retry {
            text-align: center;
            margin-top: 10px;
        }

        .leaderboard-retry button {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .leaderboard-retry button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        @keyframes leaderboard-pulse {
            0% { background-color: rgba(255, 215, 0, 0.3); }
            100% { background-color: rgba(255, 255, 255, 0.05); }
        }

        /* Container Styles for Games */
        .container {
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            width: 75%; /* Take up 75% of screen width */
            height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .games-box {
            background: #000;
            border-radius: 10px;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
            padding: 2px;
            box-shadow: 
                0 0 2px #fff,
                0 0 4px #fff,
                0 0 6px #fff,
                0 0 8px #fff,
                inset 0 0 2px rgba(255, 255, 255, 0.2);
        }

        .games-box::before {
            content: '';
            position: absolute;
            inset: -1px;
            background: #fff;
            border-radius: 10px;
            z-index: -1;
            box-shadow: 
                0 0 15px #fff,
                0 0 30px rgba(255, 255, 255, 0.8),
                0 0 40px rgba(255, 255, 255, 0.6),
                0 0 50px rgba(255, 255, 255, 0.4);
            opacity: 0.5;
        }

        .games-header {
            padding: 1.5rem;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            z-index: 1;
        }

        .site-title {
            font-size: 2.5rem;
            margin: 0 0 0.5rem 0;
            background: linear-gradient(45deg, #fff, #a0a0a0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: bold;
        }

        .games-title {
            font-size: 1.2rem;
            margin: 0.5rem 0;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        #searchApps {
            width: 80%;
            max-width: 400px;
            padding: 0.8rem 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            font-size: 1rem;
            transition: all 0.3s ease;
            margin: 1rem auto 0 auto;
            display: block;
        }

        #searchApps:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
        }

        #searchApps::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .games-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1rem;
            padding: 1.5rem;
            overflow-y: auto;
            flex-grow: 1;
            position: relative;
            z-index: 1;
        }

        .games-grid::-webkit-scrollbar {
            width: 8px;
        }

        .games-grid::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            margin: 4px;
            border-radius: 4px;
        }

        .games-grid::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        .games-grid::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .game-item {
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            transition: all 0.3s ease;
            cursor: pointer;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.8rem;
        }

        .game-icon {
            width: 64px;
            height: 64px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .game-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .game-title {
            font-size: 0.9rem;
            color: #fff;
            margin: 0;
            font-weight: normal;
            transition: all 0.3s ease;
        }

        .game-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .game-item:hover .game-title {
            color: #fff;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        /* Notification Animation */
        @keyframes notification {
            0% { opacity: 0; transform: translateY(20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }

        .notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 12px 20px;
            border-radius: 5px;
            font-size: 0.9rem;
            z-index: 10000; /* Above theme background */
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            animation: notification 3s ease forwards;
        }

        .notification.success {
            border-left: 4px solid #4CAF50;
        }

        .notification.error {
            border-left: 4px solid #f44336;
        }

        /* Responsive adjustments */
        @media (max-width: 1200px) {
            .leaderboard-container {
                width: 30%;
            }
            
            .container {
                width: 70%;
            }
            
            #shop-container {
                width: 700px;
            }
        }

        @media (max-width: 992px) {
            .leaderboard-container {
                width: 35%;
            }
            
            .container {
                width: 65%;
            }
            
            #shop-container {
                width: 600px;
            }
            
            .shop-items {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .leaderboard-container {
                position: fixed;
                width: 100%;
                height: 45px;
                top: 0;
                z-index: 1001;
                padding: 0;
                overflow: hidden;
            }
            
            .leaderboard-container.expanded {
                height: 300px;
                overflow-y: auto;
            }
            
            .leaderboard-toggle {
                display: flex;
            }
            
            .container {
                width: 100%;
                top: 45px;
                height: calc(100vh - 45px);
            }
            
            #shop-container {
                width: 90%;
                max-width: 500px;
            }
        }
    </style>
</head>
<body>
    <!-- Header with Profile Icon and Shop Icon -->
    <div class="header-container">
        <div id="shop-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/>
            </svg>
        </div>
        <div id="profile-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
            </svg>
        </div>
    </div>

    <!-- Authentication Container -->
    <div id="auth-container">
        <div id="user-profile" style="display:none;">
            <h3>Welcome, <span id="username-display"></span>!</h3>
            <p>Coins: <span id="balance-display">0</span></p>
            <button id="logout-btn">Logout</button>
        </div>

        <div id="login-form">
            <h3>Login</h3>
            <input type="email" id="login-email" placeholder="Email">
            <input type="password" id="login-password" placeholder="Password">
            <button id="login-btn">Login</button>
        </div>
        
        <div id="register-form">
            <h3>Register</h3>
            <input type="text" id="register-username" placeholder="Username">
            <input type="email" id="register-email" placeholder="Email">
            <input type="password" id="register-password" placeholder="Password">
            <button id="register-btn">Register</button>
        </div>
    </div>

    <!-- Improved Shop Container with New Themes -->
    <div id="shop-container" style="display: none;">
        <button class="shop-close">&times;</button>
        <div class="shop-header">
            <h2 class="shop-title">Void Network Shop</h2>
            <p class="shop-balance">Your Balance: <span id="shop-balance-display">0</span> coins</p>
        </div>
        <div class="shop-items-container">
            <div class="shop-category">Themes</div>
            <div class="shop-items">
                <!-- Forest Theme Item -->
                <div class="shop-item" data-item-id="forest_theme" data-price="1000000">
                    <div class="shop-item-image">
                        <img src="https://lh7-us.googleusercontent.com/v_s_bK2lQgL2sAvLaZfdZJoy1A9V6x_feCZubeL1von2XD-QQhD5l9A8GmGcdJKGzSOcGkJTrTJB34rY3V-xzRr_4x5qgZB5a8L3Pg5YMeNwZnSuM740jUjvuupmAD4-D4ARNIlfVqwiECIG1fWnDadh0tri-Q" alt="Forest Theme">
                    </div>
                    <div class="shop-item-details">
                        <h3 class="shop-item-title">Forest Theme</h3>
                        <p class="shop-item-description">Transform your Void Network experience with lush forest visuals and ambient nature sounds.</p>
                        <div class="shop-item-price">
                            <span class="price-amount">1,000,000 coins</span>
                            <button class="buy-button" data-item-id="forest_theme">Buy</button>
                        </div>
                    </div>
                </div>
                
                <!-- City Theme Item -->
                <div class="shop-item" data-item-id="city_theme" data-price="2500000">
                    <div class="shop-item-image">
                        <img src="https://lh7-us.googleusercontent.com/OlgmXm_auGwC6ga8ZVXSx_eqeCfm2bYpMKd3ylW4eLqMZ45CicWeMwJBoUhnYgEdwdEK3bzaMUHt5fIDFk_eaHKFy6cUSjbeEWBIB1TiIxk1trjPXNvFTgEAuaaEx-rO1q0UZ2k6GgZyiyrzWoK-xLQcpUdKWA" alt="City Theme">
                    </div>
                    <div class="shop-item-details">
                        <h3 class="shop-item-title">City Theme</h3>
                        <p class="shop-item-description">Experience the urban landscape with this sleek city theme. Feel the pulse of city life as you play.</p>
                        <div class="shop-item-price">
                            <span class="price-amount">2,000,000 coins</span>
                            <button class="buy-button" data-item-id="city_theme">Buy</button>
                        </div>
                    </div>
                </div>
                
                <!-- Desert Theme Item -->
                <div class="shop-item" data-item-id="desert_theme" data-price="300000000">
                    <div class="shop-item-image">
                        <img src="https://lh7-us.googleusercontent.com/kPKB3cpqgwfvkFv_TOM1YsJyG0J46BVOOx7nLtS94V1QYWMgJD_BHQnqj_xSG5oIy0oVLo1zi2Com1sJopFqupa-KOuCMOONyVMhoWw0Tlu_GQR5ImRpoaKk3Qp7RRZGvCSqjjopA1YGz4Pko-IBFD_XBl1mLg" alt="Desert Theme">
                    </div>
                    <div class="shop-item-details">
                        <h3 class="shop-item-title">Desert Theme</h3>
                        <p class="shop-item-description">Immerse yourself in the vast tranquility of the desert. Experience the serene beauty of golden sands.</p>
                        <div class="shop-item-price">
                            <span class="price-amount">300,000,000 coins</span>
                            <button class="buy-button" data-item-id="desert_theme">Buy</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="shop-category">Coming Soon</div>
            <div class="shop-items">
                <!-- Placeholder Item 1 -->
                <div class="shop-item" data-item-id="placeholder_1" data-price="50000000">
                    <div class="shop-item-image">
                        <img src="/api/placeholder/400/320" alt="Coming Soon">
                    </div>
                    <div class="shop-item-details">
                        <h3 class="shop-item-title">Ocean Theme</h3>
                        <p class="shop-item-description">Coming soon! Dive into an underwater adventure with this theme.</p>
                        <div class="shop-item-price">
                            <span class="price-amount">50,000,000 coins</span>
                            <button class="buy-button" data-item-id="placeholder_1" disabled>Coming Soon</button>
                        </div>
                    </div>
                </div>
                
                <!-- Placeholder Item 2 -->
                <div class="shop-item" data-item-id="placeholder_2" data-price="75000000">
                    <div class="shop-item-image">
                        <img src="/api/placeholder/400/320" alt="Coming Soon">
                    </div>
                    <div class="shop-item-details">
                        <h3 class="shop-item-title">Space Theme</h3>
                        <p class="shop-item-description">Coming soon! Take your games to the stars with cosmic visuals.</p>
                        <div class="shop-item-price">
                            <span class="price-amount">75,000,000 coins</span>
                            <button class="buy-button" data-item-id="placeholder_2" disabled>Coming Soon</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaderboard Container (positioned on left) -->
    <div class="leaderboard-container">
        <div class="leaderboard-box">
            <h2 class="leaderboard-title">
                Top 20 Players
                <span class="leaderboard-toggle" id="leaderboardToggle">−</span>
            </h2>
            <div class="leaderboard-list" id="leaderboardList">
                <div class="leaderboard-loading">Loading top players...</div>
            </div>
        </div>
    </div>

    <!-- Games Container (positioned on right) -->
    <div class="container" id="main-container">
        <div class="games-box">
            <div class="games-header">
                <h1 class="site-title">Void Network</h1>
                <h2 class="games-title">Void Games</h2>
                <input type="text" id="searchApps" placeholder="Search void games...">
            </div>
            <div class="games-grid" id="gamesList"></div>
        </div>
    </div>

    <!-- Theme Background Image (placed at the end of body, with display:none by default) -->
    <img id="theme-background" src="" alt="" style="display:none;">

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-analytics.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, updateDoc, getDoc, query, where, getDocs, orderBy, limit, onSnapshot, deleteDoc, addDoc } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCkAp_GCGCtw4zv7GgHJOE9GPgIaPEuOvQ",
            authDomain: "void-games-c8d9e.firebaseapp.com",
            projectId: "void-games-c8d9e",
            storageBucket: "void-games-c8d9e.firebasestorage.app",
            messagingSenderId: "1063089929776",
            appId: "1:1063089929776:web:8e226a23a4f3ab9c5777f5"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Show notification function
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            notification.style.zIndex = '10000'; // Ensure it's above theme background
            document.body.appendChild(notification);
            
            // Remove notification after animation completes
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }

        // Theme manager to handle theme application with security improvements
        const themeManager = {
            // Track the currently equipped theme
            currentTheme: null,
            
            // Themes data with URLs
            themes: {
                'forest_theme': {
                    url: 'https://lh7-us.googleusercontent.com/v_s_bK2lQgL2sAvLaZfdZJoy1A9V6x_feCZubeL1von2XD-QQhD5l9A8GmGcdJKGzSOcGkJTrTJB34rY3V-xzRr_4x5qgZB5a8L3Pg5YMeNwZnSuM740jUjvuupmAD4-D4ARNIlfVqwiECIG1fWnDadh0tri-Q',
                    name: 'Forest Theme'
                },
                'city_theme': {
                    url: 'https://lh7-us.googleusercontent.com/OlgmXm_auGwC6ga8ZVXSx_eqeCfm2bYpMKd3ylW4eLqMZ45CicWeMwJBoUhnYgEdwdEK3bzaMUHt5fIDFk_eaHKFy6cUSjbeEWBIB1TiIxk1trjPXNvFTgEAuaaEx-rO1q0UZ2k6GgZyiyrzWoK-xLQcpUdKWA',
                    name: 'City Theme'
                },
                'desert_theme': {
                    url: 'https://lh7-us.googleusercontent.com/kPKB3cpqgwfvkFv_TOM1YsJyG0J46BVOOx7nLtS94V1QYWMgJD_BHQnqj_xSG5oIy0oVLo1zi2Com1sJopFqupa-KOuCMOONyVMhoWw0Tlu_GQR5ImRpoaKk3Qp7RRZGvCSqjjopA1YGz4Pko-IBFD_XBl1mLg',
                    name: 'Desert Theme'
                },
                'placeholder_1': {
                    url: '/api/placeholder/400/320',
                    name: 'Ocean Theme'
                },
                'placeholder_2': {
                    url: '/api/placeholder/400/320',
                    name: 'Space Theme'
                }
            },
            
            // Load a user's theme preference - Secured version
            async loadUserTheme(userId) {
                try {
                    console.log("Loading user theme preference");
                    
                    // Check if user has any equipped theme in user settings
                    const userSettingsRef = doc(db, 'user_settings', userId);
                    const userSettingsDoc = await getDoc(userSettingsRef);
                    
                    if (userSettingsDoc.exists()) {
                        const settings = userSettingsDoc.data();
                        
                        if (settings.equippedTheme) {
                            console.log("Found equipped theme:", settings.equippedTheme);
                            this.equipTheme(settings.equippedTheme);
                            this.currentTheme = settings.equippedTheme;
                            
                            // Update shop UI
                            const button = document.querySelector(`.buy-button[data-item-id="${settings.equippedTheme}"]`);
                            if (button) {
                                button.textContent = "Unequip";
                                button.classList.add('unequip');
                                button.classList.remove('equip');
                                
                                // Add equipped class to the shop item
                                const shopItem = button.closest('.shop-item');
                                if (shopItem) {
                                    shopItem.classList.add('equipped');
                                    shopItem.classList.remove('owned');
                                }
                            }
                            
                            return settings.equippedTheme;
                        }
                    }
                    
                    return null;
                } catch (error) {
                    console.error("Error loading user theme:", error);
                    return null;
                }
            },
            
            // Check which items a user has purchased - Secured version
            async checkPurchasedItems(userId) {
                try {
                    console.log("Checking user purchased items");
                    
                    // Get user purchases collection
                    const purchasesRef = collection(db, 'user_purchases', userId, 'items');
                    const purchasesSnapshot = await getDocs(purchasesRef);
                    
                    const purchasedItems = {};
                    
                    purchasesSnapshot.forEach(doc => {
                        const data = doc.data();
                        purchasedItems[data.itemId] = true;
                    });
                    
                    console.log("User purchased items:", purchasedItems);
                    
                    // Update UI for purchased items
                    Object.keys(purchasedItems).forEach(itemId => {
                        const button = document.querySelector(`.buy-button[data-item-id="${itemId}"]`);
                        if (button) {
                            // Change to "Equip" if not already equipped
                            if (itemId !== this.currentTheme) {
                                button.textContent = "Equip";
                                button.classList.add('equip');
                                button.disabled = false;
                                
                                // Add owned class to the shop item
                                const shopItem = button.closest('.shop-item');
                                if (shopItem) {
                                    shopItem.classList.add('owned');
                                }
                            }
                        }
                    });
                    
                    return purchasedItems;
                } catch (error) {
                    console.error("Error checking purchased items:", error);
                    return {};
                }
            },
            
            // Equip a theme
            equipTheme(themeId) {
                if (!this.themes[themeId]) {
                    console.error("Theme not found:", themeId);
                    return false;
                }
                
                const themeBackground = document.getElementById('theme-background');
                
                // Set the theme image
                themeBackground.src = this.themes[themeId].url;
                themeBackground.alt = this.themes[themeId].name;
                
                // Show the theme with animation
                themeBackground.style.display = 'block';
                setTimeout(() => {
                    themeBackground.classList.add('active');
                }, 50);
                
                this.currentTheme = themeId;
                
                console.log(`Equipped theme: ${themeId}`);
                return true;
            },
            
            // Unequip the current theme
            unequipTheme() {
                const themeBackground = document.getElementById('theme-background');
                
                // Hide the theme with animation
                themeBackground.classList.remove('active');
                
                // Clear src after animation is complete
                setTimeout(() => {
                    themeBackground.style.display = 'none';
                    themeBackground.src = '';
                    themeBackground.alt = '';
                }, 1000);
                
                this.currentTheme = null;
                
                console.log("Theme unequipped");
                return true;
            },
            
            // Save theme preference to user settings
            async saveThemePreference(userId, themeId) {
                try {
                    console.log(`Saving theme preference: ${themeId} for user: ${userId}`);
                    
                    const userSettingsRef = doc(db, 'user_settings', userId);
                    
                    // Only the user can modify their own settings
                    if (userId !== auth.currentUser?.uid) {
                        throw new Error("Unauthorized access");
                    }
                    
                    if (themeId) {
                        // Equipping a theme
                        await setDoc(userSettingsRef, {
                            equippedTheme: themeId,
                            lastUpdated: new Date()
                        }, { merge: true });
                    } else {
                        // Unequipping a theme
                        await setDoc(userSettingsRef, {
                            equippedTheme: null,
                            lastUpdated: new Date()
                        }, { merge: true });
                    }
                    
                    return true;
                } catch (error) {
                    console.error("Error saving theme preference:", error);
                    return false;
                }
            }
        };

        // Make sure shop container is properly hidden on page load
        document.addEventListener('DOMContentLoaded', function() {
            const shopContainer = document.getElementById('shop-container');
            if (shopContainer) {
                shopContainer.style.display = 'none';
                shopContainer.classList.remove('visible');
            }
        });

        // Profile Icon Toggle Functionality
        const profileIcon = document.getElementById('profile-icon');
        const authContainer = document.getElementById('auth-container');
        
        profileIcon.addEventListener('click', (e) => {
            e.stopPropagation(); // Prevent click from bubbling up
            
            // Close shop container if open
            const shopContainer = document.getElementById('shop-container');
            if (shopContainer) {
                shopContainer.style.display = 'none';
                shopContainer.classList.remove('visible');
            }
            
            // Toggle visibility of auth container with animation
            if (authContainer.style.display === 'block') {
                authContainer.classList.remove('visible');
                setTimeout(() => {
                    authContainer.style.display = 'none';
                }, 300);
            } else {
                authContainer.style.display = 'block';
                setTimeout(() => {
                    authContainer.classList.add('visible');
                }, 10);
                
                // If user is logged in, refresh balance display
                if (auth.currentUser) {
                    // Add a small delay to ensure any pending transactions are complete
                    setTimeout(() => {
                        voidAccounting.getUserAccountDetails(auth.currentUser.uid)
                            .then(userDetails => {
                                document.getElementById('username-display').textContent = userDetails.username;
                                document.getElementById('balance-display').textContent = userDetails.accountBalance.toLocaleString();
                            })
                            .catch(error => {
                                console.error("Error refreshing balance:", error);
                            });
                    }, 300);
                }
            }
        });

        // Improved Shop Icon Toggle Functionality
        const shopIcon = document.getElementById('shop-icon');
        const shopContainer = document.getElementById('shop-container');
        
        shopIcon.addEventListener('click', async (e) => {
            e.stopPropagation(); // Prevent click from bubbling up
            
            // Close auth container if open
            authContainer.style.display = 'none';
            authContainer.classList.remove('visible');
            
            // Toggle visibility of shop container with animation
            if (shopContainer.style.display === 'block') {
                shopContainer.classList.remove('visible');
                setTimeout(() => {
                    shopContainer.style.display = 'none';
                }, 300);
            } else {
                // Check if user is logged in
                if (!auth.currentUser) {
                    showNotification('Please log in to access the shop', 'error');
                    return;
                }
                
                shopContainer.style.display = 'block';
                setTimeout(() => {
                    shopContainer.classList.add('visible');
                }, 10);
                
                // Refresh balance in shop
                const userDetails = await voidAccounting.getUserAccountDetails(auth.currentUser.uid);
                document.getElementById('shop-balance-display').textContent = userDetails.accountBalance.toLocaleString();
                
                // Clear previous theme states
                document.querySelectorAll('.shop-item').forEach(item => {
                    item.classList.remove('owned', 'equipped');
                });
                
                // Reset all buttons first
                document.querySelectorAll('.buy-button').forEach(button => {
                    if (!button.disabled) {
                        button.textContent = "Buy";
                        button.classList.remove('equip', 'unequip');
                    }
                });
                
                // Check purchased items and update buttons
                const purchasedItems = await themeManager.checkPurchasedItems(auth.currentUser.uid);
                
                // Check currently equipped theme
                await themeManager.loadUserTheme(auth.currentUser.uid);
                
                // Update buy buttons based on user balance
                updateShopButtonsState(userDetails.accountBalance, purchasedItems);
            }
        });
        
        // Improved shop close button
        const shopCloseBtn = document.querySelector('.shop-close');
        shopCloseBtn.addEventListener('click', (e) => {
            e.stopPropagation(); // Prevent click from bubbling up
            shopContainer.classList.remove('visible');
            setTimeout(() => {
                shopContainer.style.display = 'none';
            }, 300);
        });

        // Improved click-outside handling
        document.addEventListener('click', (event) => {
            const profileIcon = document.getElementById('profile-icon');
            const authContainer = document.getElementById('auth-container');
            const shopIcon = document.getElementById('shop-icon');
            const shopContainer = document.getElementById('shop-container');
            
            // Only process if the elements exist and are visible
            if (shopContainer && shopContainer.style.display === 'block') {
                // Check if click was outside the shop and not on the shop icon
                if (!shopContainer.contains(event.target) && !shopIcon.contains(event.target)) {
                    // Close shop container
                    shopContainer.classList.remove('visible');
                    setTimeout(() => {
                        shopContainer.style.display = 'none';
                    }, 300);
                }
            }
            
            if (authContainer && authContainer.style.display === 'block') {
                if (!authContainer.contains(event.target) && !profileIcon.contains(event.target)) {
                    // Close auth container
                    authContainer.classList.remove('visible');
                    setTimeout(() => {
                        authContainer.style.display = 'none';
                    }, 300);
                }
            }
        });

        // Update shop buttons based on user balance and purchased items
        function updateShopButtonsState(userBalance, purchasedItems = {}) {
            const shopItems = document.querySelectorAll('.shop-item');
            
            shopItems.forEach(item => {
                const itemId = item.dataset.itemId;
                const itemPrice = parseInt(item.dataset.price);
                const buyButton = item.querySelector('.buy-button');
                
                // Skip buttons that are disabled for other reasons (e.g. coming soon)
                if (buyButton.textContent === 'Coming Soon') {
                    return;
                }
                
                // Reset classes
                item.classList.remove('owned', 'equipped');
                
                // If this is the equipped theme
                if (themeManager.currentTheme === itemId) {
                    buyButton.textContent = 'Unequip';
                    buyButton.disabled = false;
                    buyButton.classList.add('unequip');
                    buyButton.classList.remove('equip');
                    item.classList.add('equipped');
                    return;
                }
                
                // If user already purchased this item
                if (purchasedItems[itemId]) {
                    buyButton.textContent = 'Equip';
                    buyButton.disabled = false;
                    buyButton.classList.add('equip');
                    buyButton.classList.remove('unequip');
                    item.classList.add('owned');
                    return;
                }
                
                // If user can't afford it
                if (userBalance < itemPrice) {
                    buyButton.disabled = true;
                    buyButton.textContent = 'Not enough coins';
                    buyButton.classList.remove('equip', 'unequip');
                } else {
                    buyButton.disabled = false;
                    buyButton.textContent = 'Buy';
                    buyButton.classList.remove('equip', 'unequip');
                }
            });
        }

        // IMPROVED: Secure Purchase System using purchase requests
        async function purchaseItem(itemId, price) {
            if (!auth.currentUser) {
                showNotification('Please log in to make purchases', 'error');
                return;
            }
            
            try {
                // Get current user details to check balance
                const userDetails = await voidAccounting.getUserAccountDetails(auth.currentUser.uid);
                
                if (userDetails.accountBalance < price) {
                    showNotification('Not enough coins to make this purchase', 'error');
                    return;
                }
                
                // Create a purchase request that will be processed by a secure backend
                const purchaseRequestRef = collection(db, 'purchase_requests');
                await addDoc(purchaseRequestRef, {
                    userId: auth.currentUser.uid,
                    itemId: itemId,
                    price: price,
                    purchaseDate: new Date(),
                    status: 'pending'
                });
                
                // Create a record in user_purchases (this would normally be done by a secure backend)
                // For demo purposes this is done client-side - in production, move this to server
                await addDoc(collection(db, 'user_purchases', auth.currentUser.uid, 'items'), {
                    itemId: itemId,
                    price: price,
                    purchaseDate: new Date(),
                    itemName: getItemNameById(itemId)
                });
                
                // Record transaction request (would be processed by backend)
                await addDoc(collection(db, 'transaction_requests'), {
                    userId: auth.currentUser.uid,
                    transactionType: 'withdrawal',
                    amount: price,
                    gameId: 'shop_purchase',
                    itemId: itemId,
                    requestDate: new Date(),
                    status: 'pending'
                });
                
                // Update UI to show item as owned
                const button = document.querySelector(`.buy-button[data-item-id="${itemId}"]`);
                if (button) {
                    button.textContent = "Equip";
                    button.classList.add('equip');
                    
                    // Add owned class to shop item
                    const shopItem = button.closest('.shop-item');
                    if (shopItem) {
                        shopItem.classList.add('owned');
                    }
                }
                
                // Show success notification
                showNotification(`Purchase request submitted for ${getItemNameById(itemId)}!`, 'success');
                
                // Auto-equip the theme after purchase
                await equipItem(itemId);
                
            } catch (error) {
                console.error('Purchase error:', error);
                showNotification('Failed to complete purchase: ' + error.message, 'error');
            }
        }
        
        // Secure Equip Item implementation
        async function equipItem(itemId) {
            if (!auth.currentUser) {
                showNotification('Please log in to equip items', 'error');
                return;
            }
            
            try {
                // Reset all shop items
                document.querySelectorAll('.shop-item').forEach(item => {
                    item.classList.remove('equipped');
                    if (item.classList.contains('owned') && item.dataset.itemId !== itemId) {
                        const btn = item.querySelector('.buy-button');
                        if (btn) {
                            btn.textContent = "Equip";
                            btn.classList.remove('unequip');
                            btn.classList.add('equip');
                        }
                    }
                });
                
                // Update the button and item for this theme
                const shopItem = document.querySelector(`.shop-item[data-item-id="${itemId}"]`);
                const button = shopItem?.querySelector('.buy-button');
                
                if (button) {
                    button.textContent = "Unequip";
                    button.classList.remove('equip');
                    button.classList.add('unequip');
                }
                
                if (shopItem) {
                    shopItem.classList.add('equipped');
                    shopItem.classList.remove('owned');
                }
                
                // Equip the theme
                themeManager.equipTheme(itemId);
                
                // Save the preference to user settings
                await themeManager.saveThemePreference(auth.currentUser.uid, itemId);
                
                // Show success notification
                showNotification(`Equipped ${getItemNameById(itemId)}!`, 'success');
                
            } catch (error) {
                console.error('Equip error:', error);
                showNotification('Failed to equip item: ' + error.message, 'error');
            }
        }
        
        // Secure Unequip Item implementation
        async function unequipItem(itemId) {
            if (!auth.currentUser) {
                showNotification('Please log in to unequip items', 'error');
                return;
            }
            
            try {
                // Update the button and shop item for this theme
                const shopItem = document.querySelector(`.shop-item[data-item-id="${itemId}"]`);
                const button = shopItem?.querySelector('.buy-button');
                
                if (button) {
                    button.textContent = "Equip";
                    button.classList.remove('unequip');
                    button.classList.add('equip');
                }
                
                if (shopItem) {
                    shopItem.classList.remove('equipped');
                    shopItem.classList.add('owned');
                }
                
                // Unequip the theme
                themeManager.unequipTheme();
                
                // Save the preference to user settings
                await themeManager.saveThemePreference(auth.currentUser.uid, null);
                
                // Show success notification
                showNotification(`Unequipped ${getItemNameById(itemId)}`, 'success');
                
            } catch (error) {
                console.error('Unequip error:', error);
                showNotification('Failed to unequip item: ' + error.message, 'error');
            }
        }
        
        // Helper function to get item name by ID
        function getItemNameById(itemId) {
            const itemNames = {
                'forest_theme': 'Forest Theme',
                'city_theme': 'City Theme',
                'desert_theme': 'Desert Theme',
                'placeholder_1': 'Ocean Theme',
                'placeholder_2': 'Space Theme'
            };
            
            return itemNames[itemId] || 'Unknown Item';
        }
        
        // Add event listeners to shop buttons
        document.querySelectorAll('.buy-button').forEach(button => {
            if (button.textContent !== 'Coming Soon') {
                button.addEventListener('click', async function() {
                    const itemId = this.dataset.itemId;
                    const itemElement = document.querySelector(`.shop-item[data-item-id="${itemId}"]`);
                    const price = parseInt(itemElement.dataset.price);
                    
                    // Check button state (Buy/Equip/Unequip)
                    if (this.textContent === 'Buy') {
                        await purchaseItem(itemId, price);
                    } else if (this.textContent === 'Equip') {
                        await equipItem(itemId);
                    } else if (this.textContent === 'Unequip') {
                        await unequipItem(itemId);
                    }
                });
            }
        });

// IMPROVED: Secure VoidNetworkAccounting Class
class VoidNetworkAccounting {
    constructor() {
        this.auth = auth;
        this.db = db;
        console.log("VoidNetworkAccounting initialized");
    }

    // User Registration - UPDATED with enhanced security
    async registerUser(email, password, username) {
        try {
            // Validate inputs
            if (!email || !password || !username) {
                throw new Error('Email, password, and username are required');
            }
            
            if (password.length < 6) {
                throw new Error('Password must be at least 6 characters');
            }
            
            console.log("Checking if username already exists:", username);
            
            // Check if username already exists
            const usersRef = collection(this.db, 'users');
            const q = query(usersRef, where('username', '==', username));
            const querySnapshot = await getDocs(q);
            
            if (!querySnapshot.empty) {
                throw new Error('Username already exists. Please choose a different username.');
            }
            
            console.log("Username is available, proceeding with registration");
            
            // Create user in Firebase Auth
            const userCredential = await createUserWithEmailAndPassword(this.auth, email, password);
            const user = userCredential.user;

            // Create user profile in Firestore
            await setDoc(doc(this.db, 'users', user.uid), {
                username: username,
                createdAt: new Date(),
                accountBalance: 1000, // Starting balance
                totalGamesPlayed: 0
            });
            
            // Create public leaderboard entry
            await setDoc(doc(this.db, 'leaderboard', user.uid), {
                username: username,
                accountBalance: 1000, // Starting balance
                joinDate: new Date()
            });

            console.log("User registered successfully:", user.uid);
            return user;
        } catch (error) {
            console.error("Registration Error:", error);
            throw error;
        }
    }

    // User Login
    async loginUser(email, password) {
        try {
            console.log("Logging in user:", email);
            const userCredential = await signInWithEmailAndPassword(this.auth, email, password);
            console.log("User logged in successfully:", userCredential.user.uid);
            return userCredential.user;
        } catch (error) {
            console.error("Login Error:", error);
            throw error;
        }
    }

    // Logout
    async logout() {
        try {
            console.log("Logging out user");
            await this.auth.signOut();
            console.log("User logged out successfully");
        } catch (error) {
            console.error("Logout Error:", error);
            throw error;
        }
    }

    // Get Current User
    getCurrentUser() {
        return this.auth.currentUser;
    }

    // Get User Account Details - Secured version
    async getUserAccountDetails(userId) {
        try {
            console.log("Getting account details for user:", userId);
            
            // Security check: Only allow user to get their own details
            if (this.auth.currentUser && userId !== this.auth.currentUser.uid) {
                console.warn("User trying to access another user's details - denied");
                throw new Error('Unauthorized access');
            }
            
            const userRef = doc(this.db, 'users', userId);
            const userDoc = await getDoc(userRef);

            if (!userDoc.exists()) {
                console.error("User document not found");
                throw new Error('User not found');
            }

            const userData = userDoc.data();
            // Don't log sensitive data
            console.log("Retrieved user data for:", userData.username);
            return userData;
        } catch (error) {
            console.error("Account Details Error:", error);
            throw error;
        }
    }

    // IMPROVED: Secure Game Transaction Recording
    // This creates a transaction request rather than directly modifying the balance
    async recordGameTransaction(gameId, userId, transactionType, amount) {
        try {
            console.log(`Recording transaction request: ${transactionType} for ${amount} coins in ${gameId}`);
            
            // Security check: Only allow user to create transactions for themselves
            if (this.auth.currentUser && userId !== this.auth.currentUser.uid) {
                console.warn("User trying to create transaction for another user - denied");
                throw new Error('Unauthorized access');
            }
            
            // Create transaction request record - to be processed by secure backend
            const transactionRequestRef = collection(this.db, 'transaction_requests');
            const docRef = await addDoc(transactionRequestRef, {
                userId: userId,
                gameId: gameId,
                transactionType: transactionType,
                amount: amount,
                timestamp: new Date(),
                status: 'pending'
            });

            // Get the user's current balance for display
            const userRef = doc(this.db, 'users', userId);
            const userDoc = await getDoc(userRef);
            
            if (!userDoc.exists()) {
                throw new Error('User document not found');
            }
            
            const userData = userDoc.data();
            const currentBalance = userData.accountBalance || 0;
            
            // Return the current balance without modifying it
            // A secure backend would process the actual transaction
            return {
                requestId: docRef.id,
                currentBalance: currentBalance
            };
        } catch (error) {
            console.error("Transaction Request Error:", error);
            throw error;
        }
    }
}

// IMPROVED: Secure Leaderboard Implementation
class VoidLeaderboard {
    constructor(db) {
        this.db = db;
        this.unsubscribe = null;
        this.leaderboardElement = document.getElementById('leaderboardList');
        this.retryCount = 0;
        this.maxRetries = 3;
        this.retryTimeout = null;
        this.isMinimized = false;
        console.log("VoidLeaderboard initialized");
        
        // Set up minimize/maximize toggle
        const toggleBtn = document.getElementById('leaderboardToggle');
        if (toggleBtn) {
            toggleBtn.addEventListener('click', () => this.toggleLeaderboard());
        }
    }
    
    // Toggle leaderboard visibility
    toggleLeaderboard() {
        const container = document.querySelector('.leaderboard-container');
        const toggleBtn = document.getElementById('leaderboardToggle');
        
        if (container) {
            if (this.isMinimized) {
                // Maximize
                container.classList.remove('leaderboard-minimized');
                if (toggleBtn) toggleBtn.textContent = '−';
                this.isMinimized = false;
                
                // For mobile
                if (window.innerWidth <= 768) {
                    container.classList.add('expanded');
                }
            } else {
                // Minimize
                container.classList.add('leaderboard-minimized');
                if (toggleBtn) toggleBtn.textContent = '+';
                this.isMinimized = true;
                
                // For mobile
                if (window.innerWidth <= 768) {
                    container.classList.remove('expanded');
                }
            }
        }
    }
    
    // Start real-time leaderboard updates - Reading from public leaderboard collection
    startLeaderboardUpdates() {
        try {
            if (this.unsubscribe) {
                // If already subscribed, unsubscribe first
                this.unsubscribe();
            }
            
            // Show loading state
            if (this.leaderboardElement) {
                this.leaderboardElement.innerHTML = '<div class="leaderboard-loading">Loading top players...</div>';
            }
            
            console.log("Starting leaderboard updates");
            
            // Read from users collection since we need to show balances
            const usersRef = collection(this.db, 'users');
            const q = query(usersRef, orderBy('accountBalance', 'desc'), limit(20));
            
            // Set up real-time listener
            this.unsubscribe = onSnapshot(q, 
                {
                    includeMetadataChanges: true
                },
                (querySnapshot) => {
                    // Reset retry count on successful data
                    this.retryCount = 0;
                    
                    // Update UI with the snapshot data
                    this.updateLeaderboardUI(querySnapshot);
                }, 
                (error) => {
                    console.error("Leaderboard listener error:", error);
                    
                    // Retry after a short delay
                    if (this.retryCount < 5) {
                        this.retryCount++;
                        console.log(`Retrying Firebase connection (${this.retryCount}/5)...`);
                        setTimeout(() => this.startLeaderboardUpdates(), 2000);
                    }
                }
            );
        } catch (error) {
            console.error("Error setting up leaderboard:", error);
            // Retry immediately if there's an error
            setTimeout(() => this.startLeaderboardUpdates(), 1000);
        }
    }
    
// IMPROVED: Secure leaderboard UI update with ban filtering and always showing 20 entries
updateLeaderboardUI(querySnapshot) {
    if (!this.leaderboardElement) {
        console.error("Leaderboard element not found");
        return;
    }
    
    // Always clear the leaderboard completely first
    this.leaderboardElement.innerHTML = '';
    
    if (querySnapshot.empty) {
        this.leaderboardElement.innerHTML = '<div class="leaderboard-loading">No players yet</div>';
        return;
    }
    
    console.log("Updating leaderboard with new data");
    
    // Create array of valid users to display - FILTER OUT BANNED USERS
    const validUsers = [];
    querySnapshot.forEach((doc) => {
        if (doc.exists()) {
            const userData = doc.data();
            
            // Skip banned users
            if (userData.banned !== true) {
                validUsers.push({
                    username: userData.username || 'Unknown',
                    accountBalance: userData.accountBalance || 0
                });
            } else {
                console.log(`Skipping banned user: ${userData.username || 'Unknown'}`);
            }
        }
    });
    
    // Display valid users (up to 20)
    const displayCount = Math.min(validUsers.length, 20);
    
    for (let i = 0; i < displayCount; i++) {
        const userData = validUsers[i];
        const leaderboardItem = document.createElement('div');
        leaderboardItem.className = 'leaderboard-item';
        
        // Add animation class for new/updated items
        leaderboardItem.classList.add('leaderboard-updated');
        
        // Create structure with username container for proper text truncation
        leaderboardItem.innerHTML = `
            <span class="leaderboard-rank">#${i + 1}</span>
            <div class="leaderboard-username-container">
                <span class="leaderboard-username">${userData.username}</span>
            </div>
            <span class="leaderboard-balance">${userData.accountBalance.toLocaleString()}</span>
        `;
        
        this.leaderboardElement.appendChild(leaderboardItem);
        
        // Remove animation class after animation is complete
        setTimeout(() => {
            leaderboardItem.classList.remove('leaderboard-updated');
        }, 1000);
    }
    
    // Add placeholders to ensure we always show 20 entries
    for (let i = displayCount; i < 20; i++) {
        const placeholderItem = document.createElement('div');
        placeholderItem.className = 'leaderboard-item';
        
        placeholderItem.innerHTML = `
            <span class="leaderboard-rank">#${i + 1}</span>
            <div class="leaderboard-username-container">
                <span class="leaderboard-username">...</span>
            </div>
            <span class="leaderboard-balance">--</span>
        `;
        
        this.leaderboardElement.appendChild(placeholderItem);
    }
    
    console.log(`Leaderboard updated with ${displayCount} players and ${20 - displayCount} placeholders`);
    
    // Find and highlight VoidNetworkOnTop
    this.highlightSpecialUsers();
    
    // If we don't have 20 valid users, try to fetch more
    if (validUsers.length < 20 && querySnapshot.size >= 20) {
        this.fetchMoreUsers(validUsers.length);
    }
}

// Add new method to fetch more users when we don't have enough for the leaderboard
async fetchMoreUsers(currentCount) {
    try {
        // Only proceed if we have some data but not enough
        if (currentCount <= 0 || currentCount >= 20) return;
        
        console.log(`Only have ${currentCount} valid users, fetching more...`);
        
        // Get the last visible user's balance
        const lastVisible = this.leaderboardElement.querySelector(`.leaderboard-item:nth-child(${currentCount}) .leaderboard-balance`);
        if (!lastVisible) return;
        
        // Convert balance text back to number (remove commas)
        const lastBalanceText = lastVisible.textContent;
        const lastBalance = parseInt(lastBalanceText.replace(/,/g, ''));
        
        if (isNaN(lastBalance)) return;
        
        // Query for more users with lower balance
        const usersRef = collection(this.db, 'users');
        const moreUsers = query(
            usersRef,
            orderBy('accountBalance', 'desc'),
            where('accountBalance', '<', lastBalance),
            limit(40) // Get more to account for potential banned users
        );
        
        const moreSnapshot = await getDocs(moreUsers);
        
        if (moreSnapshot.empty) return;
        
        // Filter valid non-banned users
        const additionalUsers = [];
        moreSnapshot.forEach(doc => {
            if (doc.exists()) {
                const userData = doc.data();
                if (userData.banned !== true) {
                    additionalUsers.push({
                        username: userData.username || 'Unknown',
                        accountBalance: userData.accountBalance || 0
                    });
                }
            }
        });
        
        // Calculate how many more we need
        const needed = 20 - currentCount;
        const toAdd = Math.min(needed, additionalUsers.length);
        
        if (toAdd <= 0) return;
        
        console.log(`Adding ${toAdd} more users to complete the leaderboard`);
        
        // Replace placeholders with real users
        for (let i = 0; i < toAdd; i++) {
            const userData = additionalUsers[i];
            const rank = currentCount + i + 1;
            
            // Find the placeholder to replace
            const placeholder = this.leaderboardElement.querySelector(`.leaderboard-item:nth-child(${rank})`);
            if (placeholder) {
                // Create the real user entry
                const userItem = document.createElement('div');
                userItem.className = 'leaderboard-item leaderboard-updated';
                
                userItem.innerHTML = `
                    <span class="leaderboard-rank">#${rank}</span>
                    <div class="leaderboard-username-container">
                        <span class="leaderboard-username">${userData.username}</span>
                    </div>
                    <span class="leaderboard-balance">${userData.accountBalance.toLocaleString()}</span>
                `;
                
                // Replace the placeholder
                placeholder.parentNode.replaceChild(userItem, placeholder);
                
                // Remove animation class after delay
                setTimeout(() => {
                    userItem.classList.remove('leaderboard-updated');
                }, 1000);
            }
        }
        
        // Highlight any special users in the new entries
        this.highlightSpecialUsers();
        
    } catch (error) {
        console.error("Error fetching more users:", error);
    }
}
    
    // Specifically highlight special usernames
    highlightSpecialUsers() {
        const usernameElements = this.leaderboardElement.querySelectorAll('.leaderboard-username');
        
        usernameElements.forEach(el => {
            // Explicitly check for "VoidNetworkOnTop" username
            if (el.textContent === 'VoidNetworkOnTop') {
                // Apply blue styling
                el.style.color = '#1DA1F2';
                el.style.textShadow = '0 0 5px rgba(29, 161, 242, 0.3)';
                el.style.fontWeight = 'bold';
                
                // Add verification badge if it doesn't exist
                if (!el.querySelector('.verified-badge')) {
                    const badge = document.createElement('span');
                    badge.className = 'verified-badge';
                    badge.textContent = '✓';
                    badge.style.marginLeft = '4px';
                    badge.style.color = '#1DA1F2';
                    el.appendChild(badge);
                }
            }
        });
    }

    // Stop leaderboard updates
    stopLeaderboardUpdates() {
        if (this.unsubscribe) {
            console.log("Stopping leaderboard updates");
            this.unsubscribe();
            this.unsubscribe = null;
        }
        
        // Clear any pending timeouts
        if (this.retryTimeout) {
            clearTimeout(this.retryTimeout);
        }
    }
}

// Initialize Accounting System
const voidAccounting = new VoidNetworkAccounting();

// Initialize Leaderboard
const voidLeaderboard = new VoidLeaderboard(db);

// Helper function to highlight VoidNetworkOnTop in the leaderboard
function refreshLeaderboard() {
    console.log("Manual leaderboard refresh requested");
    
    // Stop current listener and restart to force refresh
    voidLeaderboard.stopLeaderboardUpdates();
    
    // Force a new connection attempt
    voidLeaderboard.startLeaderboardUpdates();
    
    // After a short delay, manually highlight special users
    setTimeout(() => voidLeaderboard.highlightSpecialUsers(), 1000);
}

// Detect screen size changes to handle mobile responsive layout
function handleResponsiveLayout() {
    const leaderboardContainer = document.querySelector('.leaderboard-container');
    
    if (window.innerWidth <= 768) {
        // For mobile: Show the toggle button for collapse/expand
        if (leaderboardContainer) {
            const toggleBtn = document.getElementById('leaderboardToggle');
            if (toggleBtn) {
                toggleBtn.style.display = 'flex';
            }
            
            // Auto-collapse on mobile initially
            if (!voidLeaderboard.isMinimized && !leaderboardContainer.classList.contains('expanded')) {
                voidLeaderboard.isMinimized = true;
            }
        }
    } else {
        // For desktop: hide the toggle button as the leaderboard is always visible
        const toggleBtn = document.getElementById('leaderboardToggle');
        if (toggleBtn) {
            toggleBtn.style.display = 'none';
        }
        
        // Reset any mobile-specific classes
        if (leaderboardContainer) {
            leaderboardContainer.classList.remove('expanded');
        }
    }
}

// Initialize layout once DOM is loaded
window.addEventListener('load', () => {
    handleResponsiveLayout();
});

// Check on window resize
window.addEventListener('resize', handleResponsiveLayout);

// Authentication Event Listeners
document.getElementById('login-btn')?.addEventListener('click', async () => {
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;
    
    if (!email || !password) {
        alert('Please enter both email and password');
        return;
    }
    
    try {
        const user = await voidAccounting.loginUser(email, password);
        console.log('Logged in user:', user);
        await updateUIForLoggedInUser(user);
        authContainer.style.display = 'none'; // Hide auth container after login
        authContainer.classList.remove('visible');
    } catch (error) {
        alert('Login failed: ' + error.message);
    }
});

document.getElementById('register-btn')?.addEventListener('click', async () => {
    const username = document.getElementById('register-username').value;
    const email = document.getElementById('register-email').value;
    const password = document.getElementById('register-password').value;
    
    if (!username || !email || !password) {
        alert('Please fill in all fields');
        return;
    }
    
    try {
        const user = await voidAccounting.registerUser(email, password, username);
        console.log('Registered user:', user);
        await updateUIForLoggedInUser(user);
        authContainer.style.display = 'none'; // Hide auth container after registration
        authContainer.classList.remove('visible');
    } catch (error) {
        alert('Registration failed: ' + error.message);
    }
});

document.getElementById('logout-btn')?.addEventListener('click', async () => {
    try {
        // Unequip any theme before logging out
        if (themeManager.currentTheme) {
            themeManager.unequipTheme();
        }
        
        await voidAccounting.logout();
        updateUIForLoggedOutUser();
        
        // Close shop container if open
        shopContainer.style.display = 'none';
        shopContainer.classList.remove('visible');
    } catch (error) {
        alert('Logout failed: ' + error.message);
    }
});

// Update UI based on authentication state
async function updateUIForLoggedInUser(user) {
    document.getElementById('login-form').style.display = 'none';
    document.getElementById('register-form').style.display = 'none';
    document.getElementById('user-profile').style.display = 'block';
    
    try {
        // Fetch fresh user details
        const userDetails = await voidAccounting.getUserAccountDetails(user.uid);
        document.getElementById('username-display').textContent = userDetails.username;
        document.getElementById('balance-display').textContent = userDetails.accountBalance.toLocaleString();
        console.log("Updated UI with username:", userDetails.username);
        
        // Load user's theme if they have one equipped
        await themeManager.loadUserTheme(user.uid);
    } catch (error) {
        console.error("Error updating UI:", error);
        alert('Could not load user details. Please try again.');
    }
}

function updateUIForLoggedOutUser() {
    document.getElementById('login-form').style.display = 'block';
    document.getElementById('register-form').style.display = 'block';
    document.getElementById('user-profile').style.display = 'none';
}

// Listen for authentication state changes
onAuthStateChanged(auth, async (user) => {
    if (user) {
        console.log("Auth state changed: User is signed in", user.uid);
        await updateUIForLoggedInUser(user);
    } else {
        console.log("Auth state changed: User is signed out");
        updateUIForLoggedOutUser();
        
        // Make sure theme is unequipped when logged out
        themeManager.unequipTheme();
    }
});

// Game loading logic
const defaultApps = [
    {
        title: "Ball Dropper",
        imgSrc: "https://lh7-us.googleusercontent.com/CUj18dKaBkXv0WI59qpP2-Ub1J0KHyKXwgnhPBdmzDzwhQNvIkwPsrVLJCiSsS0iNOaF8-nAamakuiFLoRzYIGyOr-LOFJg9hD5IA9cIvjh5ZIHmBhT-hel39crAOTgz88P8jX2WApcC5PDnLbabDK_QC1vyFw",
        link: "/local games/Plinko/plinko.html"
    },
    {
        title: "MineFeild",
        imgSrc: "https://lh7-us.googleusercontent.com/WAjTfpxFqdXwMOlzyChcCi40sg6-ukZN5u24gdmWyi9_Yca5-V8vBR6zrgOoADGwKKJM7e7cKEkq9i_chkYesJvN_VVnvKAfUOPIllTxR2mbOK-HiR0vlIgH_2_bY2Oqzh2ndVieVycQoGDMXuZC-8gpE85Ypg",
        link: "/local games/CrossyRoad/crossy.html"
    },
    {
        title: "Memory Squares",
        imgSrc: "https://lh7-us.googleusercontent.com/USI3iEwtHyyyN6fdMllkREQg8h8N7xsXxw94Wb0umSNOzvXTgMtBtxMBXwgyVOHirbrZCVGU1JDeyVaW94xuTS-4vEvT1iZzriw3We_RIYDPW63aWxDEj8xZ_d7Nc3vi6LfrEr20QOOMvnWL8JD5XgbbC-PjKA",
        link: "/local games/memory-square/mem.html"
    },
    {
        title: "VoidSnake",
        imgSrc: "https://lh7-us.googleusercontent.com/zPbDytQWYmY90BK7jPcdb8QQ8QNz4LWyhwUq1zNWiD64NNGC_8L21T_QDOl9z8R9QRvJtkFRvM9f83ODmjJJYgG6sZwi71SPiTUwASMOaofbb7wIOKEQJ-Wq1VSGVlCg3RmSdC7B4d-SGOfs_hRdmKjtxHbGOQ",
        link: "/local games/Void Snake/Voidsnake.html"
    },
    {
        title: "Heads Or Tails?",
        imgSrc: "https://lh7-us.googleusercontent.com/jpunH9P0O_of8oU2ZilkliydM46qFTQxD__XgzIKv3OU7zZi77arrF9F2hGe-wgyzO5-57VJvN1zocVFN8549jIDkN2rKc9xEjcywhhJCldCaJkZnMgyEHtwJPuUsZZSu4DsK-L2b2eQGepfKwhgn4p7tgzrqA",
        link: "/local games/CoinFlip/coinflip.html"
    },
    {
        title: "Chicken Run",
        imgSrc: "https://lh7-us.googleusercontent.com/JugrfbksXzV3Mwwp32MOX-DHGD1EQJmZIaB_RYn9VBvoihT7-bClXPzyfYJC4mGXsYsdTMWJh-Xxe8L9wpHrGntuc0Shzu9tqKCTSug-jM2SiW1BIBcok9Fxlz0JvZEqaKVMbSWK1dlWmw8caafDFRErSox7YA",
        link: "/local games/ChickenRun/chickenrun.html"
    },
    {
        title: "Black Jack",
        imgSrc: "https://lh7-us.googleusercontent.com/YCrV9BMUqwQWnxde1-xnx_Tm-SrbaCE1A-p6ZgIgCcS80FhpHxDVywGlECGcfv38KVt7kZq2Psb3CRSg4II9CQnCrMaLl-K4w9ca7gFNtxbYivqas9udPBTh1WwjW2H4CNi-HjO02TwonHFNHngzl-xGheNklA",
        link: "/local games/BlackJack/BlackJack.html"
    },
];

function renderAppsList() {
    const gamesList = document.getElementById("gamesList");
    
    if (!gamesList) {
        console.error("Games list element not found");
        return;
    }
    
    gamesList.innerHTML = '';
    console.log("Rendering games list");
    
    defaultApps.forEach(app => {
        const appElement = document.createElement("div");
        appElement.className = "game-item";
        
        appElement.innerHTML = `
            <div class="game-icon">
                <img src="${app.imgSrc}" alt="${app.title} icon">
            </div>
            <h3 class="game-title">${app.title}</h3>
        `;

        appElement.onclick = () => {
            // Check if user is logged in before navigating to game
            const currentUser = voidAccounting.getCurrentUser();
            if (currentUser) {
                console.log("Navigating to game:", app.title);
                
// Record the game play attempt
                voidAccounting.recordGameTransaction(
                    app.title.toLowerCase().replace(/\s+/g, '_'), 
                    currentUser.uid,
                    'game_play',
                    0 // Just tracking the visit, not charging coins here
                ).then(() => {
                    // Navigate to the game after transaction is recorded
                    window.location.href = app.link;
                }).catch(error => {
                    console.error("Error recording game visit:", error);
                    // Still navigate even if tracking fails
                    window.location.href = app.link;
                });
            } else {
                alert('Please login to play games');
                authContainer.style.display = 'block';
                setTimeout(() => {
                    authContainer.classList.add('visible');
                }, 10);
            }
        };

        gamesList.appendChild(appElement);
    });
}

document.getElementById("searchApps")?.addEventListener("keyup", function(e) {
    const gamesList = document.getElementById("gamesList");
    const searchTerm = this.value.toLowerCase();
    
    if (!gamesList) return;
    
    gamesList.innerHTML = '';
    
    defaultApps.forEach(app => {
        if (app.title.toLowerCase().includes(searchTerm)) {
            const appElement = document.createElement("div");
            appElement.className = "game-item";
            
            appElement.innerHTML = `
                <div class="game-icon">
                    <img src="${app.imgSrc}" alt="${app.title} icon">
                </div>
                <h3 class="game-title">${app.title}</h3>
            `;

            appElement.onclick = () => {
                // Check if user is logged in before navigating to game
                const currentUser = voidAccounting.getCurrentUser();
                if (currentUser) {
                    // Record the game play attempt
                    voidAccounting.recordGameTransaction(
                        app.title.toLowerCase().replace(/\s+/g, '_'), 
                        currentUser.uid,
                        'game_play',
                        0 // Just tracking the visit, not charging coins here
                    ).then(() => {
                        // Navigate to the game after transaction is recorded
                        window.location.href = app.link;
                    }).catch(error => {
                        console.error("Error recording game visit:", error);
                        // Still navigate even if tracking fails
                        window.location.href = app.link;
                    });
                } else {
                    alert('Please login to play games');
                    authContainer.style.display = 'block';
                    setTimeout(() => {
                        authContainer.classList.add('visible');
                    }, 10);
                }
            };

            gamesList.appendChild(appElement);
        }
    });
});

// Add periodic refresh to ensure leaderboard stays updated
setInterval(refreshLeaderboard, 30000); // Refresh every 30 seconds

// Load apps and start leaderboard on page load
window.addEventListener('load', async () => {
    try {
        console.log("Page loaded, initializing app");
        renderAppsList();
        
        // Start leaderboard updates
        voidLeaderboard.startLeaderboardUpdates();
        
        // Check if user is already logged in
        const user = auth.currentUser;
        if (user) {
            console.log("User already logged in:", user.uid);
            await updateUIForLoggedInUser(user);
        }
    } catch (err) {
        console.error('Error during initialization:', err);
    }
});

// Stop leaderboard updates when user leaves the page
window.addEventListener('beforeunload', () => {
    voidLeaderboard.stopLeaderboardUpdates();
});
    </script>
</body>
</html>
