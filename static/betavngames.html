<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>The Void Games - Ball Dropper</title>
  <!-- Favicon -->
  <link rel="shortcut icon" href="./assets/favicon.png" type="image/png">
  <style>
    /* Global Styles */
    body, html {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background: #000;
      color: #fff;
      font-family: Arial, sans-serif;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .game-container {
      background: #000;
      border-radius: 10px;
      width: 90%;
      max-width: 800px;
      height: 90vh;
      max-height: 800px;
      display: flex;
      flex-direction: column;
      position: relative;
      padding: 1rem;
      box-shadow: 
        0 0 2px #fff,
        0 0 4px #fff,
        0 0 6px #fff,
        0 0 8px #fff,
        inset 0 0 2px rgba(255, 255, 255, 0.2);
      z-index: 3;
    }

    .game-container::before {
      content: '';
      position: absolute;
      inset: -1px;
      background: transparent;
      border-radius: 10px;
      z-index: -1;
      box-shadow: 
        0 0 15px #fff,
        0 0 30px rgba(255, 255, 255, 0.8),
        0 0 40px rgba(255, 255, 255, 0.6),
        0 0 50px rgba(255, 255, 255, 0.4);
      opacity: 0.5;
    }

    .game-header {
      text-align: center;
      padding-bottom: 1rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      position: relative;
    }

    .game-title {
      font-size: 2rem;
      margin: 0 0 0.5rem 0;
      background: linear-gradient(45deg, #fff, #a0a0a0);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .game-subtitle {
      font-size: 1rem;
      color: #888;
      margin: 0;
    }

    .coin-tracker {
      position: absolute;
      top: 0;
      right: 0;
      background: linear-gradient(135deg, #333, #222);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 30px;
      padding: 0.5rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
      animation: glow 2s infinite;
    }

    .coin-icon {
      width: 20px;
      height: 20px;
      background: linear-gradient(135deg, #FFD700, #FFA500);
      border-radius: 50%;
      box-shadow: 0 0 5px rgba(255, 215, 0, 0.8);
    }

    .coin-amount {
      font-weight: bold;
      font-size: 1.1rem;
      color: #FFD700;
    }

    .game-board {
      flex-grow: 1;
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    #canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: transparent;
    }

    .controls {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 1rem 0;
      gap: 1rem;
    }

    .drop-btn {
      padding: 0.75rem 2rem;
      font-size: 1.2rem;
      background: linear-gradient(135deg, #333, #222);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 30px;
      cursor: pointer;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 2px;
      font-weight: bold;
    }

    .drop-btn:hover {
      background: linear-gradient(135deg, #444, #333);
      transform: translateY(-2px);
      box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
    }

    .drop-btn:active {
      transform: translateY(1px);
    }

    .drop-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: linear-gradient(135deg, #444, #333);
    }
       
    .drop-btn.insufficient {
      background: linear-gradient(135deg, #800, #600);
      color: #ffcccc;
    }

    .reset-btn {
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      background: linear-gradient(135deg, #222, #111);
      color: #888;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 30px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .reset-btn:hover {
      color: #fff;
      border-color: rgba(255, 255, 255, 0.3);
    }

    .score-display {
      text-align: center;
      margin-top: 1rem;
      font-size: 1.2rem;
      height: 1.5rem;
    }

    .win-amount {
      font-weight: bold;
      font-size: 1.4rem;
      color: #4caf50;
    }

    .lose-amount {
      font-weight: bold;
      font-size: 1.4rem;
      color: #f44336;
    }

    .back-link {
      margin-top: 1rem;
      color: rgba(255, 255, 255, 0.7);
      text-decoration: none;
      font-size: 0.9rem;
      transition: color 0.3s ease;
    }

    .back-link:hover {
      color: #fff;
      text-decoration: underline;
    }

    @media (max-width: 768px) {
      .game-container {
        width: 95%;
        height: 80vh;
      }
      
      .game-title {
        font-size: 1.5rem;
      }
      
      .drop-btn, .reset-btn {
        padding: 0.6rem 1.5rem;
        font-size: 1rem;
      }

      .coin-tracker {
        padding: 0.3rem 0.8rem;
      }

      .coin-icon {
        width: 16px;
        height: 16px;
      }

      .coin-amount {
        font-size: 0.9rem;
      }
    }

    /* Special Effects */
    @keyframes glow {
      0% { filter: drop-shadow(0 0 2px rgba(255, 255, 255, 0.7)); }
      50% { filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.9)); }
      100% { filter: drop-shadow(0 0 2px rgba(255, 255, 255, 0.7)); }
    }
  </style>
</head>
<body>
  <div class="game-container">
    <div class="game-header">
      <h1 class="game-title">Ball Dropper</h1>
      <p class="game-subtitle">Drop the ball and test your luck</p>
      <div class="coin-tracker">
        <div class="coin-icon"></div>
        <span class="coin-amount" id="coinDisplay">0</span>
      </div>
    </div>
    <div class="game-board">
      <canvas id="canvas"></canvas>
    </div>
    <div class="score-display" id="scoreDisplay"></div>
    <div class="controls">
      <button id="dropButton" class="drop-btn">Drop</button>
      <button id="resetButton" class="reset-btn">Reset</button>
    </div>
  </div>
  <a href="index.html" class="back-link">Back</a>

  <!-- Firebase SDK & Initialization -->
  <script type="module">
    // Firebase Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyB04yFuvFnJrTa4FYgvRIUJFp0Qvk9JHDQ",
      authDomain: "void-network-games.firebaseapp.com",
      projectId: "void-network-games",
      storageBucket: "void-network-games.appspot.com",
      messagingSenderId: "878896483861",
      appId: "1:878896483861:web:a876f521a8fc0faed0881c",
      measurementId: "G-0PV8WC36X7"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Global variables for authentication and coin management
    let currentUser = null;
    let firebaseCoinBalance = 0;

    // Listen for authentication state changes
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        await loadFirebaseCoinBalance();
      } else {
        currentUser = null;
        showLoginPrompt();
      }
    });

    // Load coin balance from Firestore using user.uid
    async function loadFirebaseCoinBalance() {
      if (!currentUser) return;
      try {
        const userRef = doc(db, 'users', currentUser.uid);
        const userDoc = await getDoc(userRef);
        if (userDoc.exists()) {
          firebaseCoinBalance = userDoc.data().accountBalance || 0;
          window.coinBalance = firebaseCoinBalance;
          window.updateCoinDisplay();
          window.setupGame();
        } else {
          await setDoc(userRef, { accountBalance: 1000 });
          window.coinBalance = 1000;
          window.updateCoinDisplay();
        }
      } catch (error) {
        console.error("Error loading coin balance:", error);
        showLoginPrompt();
      }
    }

    // Update coin balance in Firestore using user.uid
    async function updateFirebaseCoinBalance(newBalance) {
      if (!currentUser) return;
      try {
        const userRef = doc(db, 'users', currentUser.uid);
        await updateDoc(userRef, { accountBalance: newBalance });
      } catch (error) {
        console.error("Error updating coin balance:", error);
      }
    }

    // Display a login prompt if no user is authenticated
    function showLoginPrompt() {
      const overlay = document.createElement('div');
      overlay.style.position = 'fixed';
      overlay.style.top = '0';
      overlay.style.left = '0';
      overlay.style.width = '100%';
      overlay.style.height = '100%';
      overlay.style.background = 'rgba(0,0,0,0.8)';
      overlay.style.display = 'flex';
      overlay.style.justifyContent = 'center';
      overlay.style.alignItems = 'center';
      overlay.style.zIndex = '1000';

      const modalContent = document.createElement('div');
      modalContent.style.background = '#222';
      modalContent.style.padding = '2rem';
      modalContent.style.borderRadius = '10px';
      modalContent.style.textAlign = 'center';
      modalContent.style.color = 'white';

      modalContent.innerHTML = `
        <h2>Login Required</h2>
        <p>Please log in to play Ball Dropper and track your coins.</p>
        <div>
          <button id="loginBtn" style="background: #4CAF50; color: white; border: none; padding: 10px 20px; margin: 10px; border-radius: 5px; cursor: pointer;">Go to Login</button>
          <button id="cancelBtn" style="background: #f44336; color: white; border: none; padding: 10px 20px; margin: 10px; border-radius: 5px; cursor: pointer;">Cancel</button>
        </div>
      `;
      overlay.appendChild(modalContent);
      document.body.appendChild(overlay);

      document.getElementById('loginBtn').addEventListener('click', () => {
        window.location.href = 'index.html';
      });
      document.getElementById('cancelBtn').addEventListener('click', () => {
        document.body.removeChild(overlay);
        window.dropButton.disabled = true;
        window.dropButton.innerHTML = 'Login to Play';
      });
    }

    // Expose functions for use in game logic
    window.loadFirebaseCoinBalance = loadFirebaseCoinBalance;
    window.updateFirebaseCoinBalance = updateFirebaseCoinBalance;
    window.showLoginPrompt = showLoginPrompt;
  </script>

  <!-- Game Logic -->
  <script>
    // Game Configuration
    const config = {
      ballRadius: 7,
      pegRadius: 3.5,
      pegSpacing: 45,
      pegRows: 10,
      dropSpeed: 2.5,
      gravity: 0.25,
      friction: 0.9,
      bounceSpeed: 0.6,
      buckets: 5,
      minReward: -600,
      maxReward: 500
    };

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let canvasWidth, canvasHeight;
    let ball = null;
    let pegs = [];
    let buckets = [];
    let gameActive = false;
    let gameComplete = false;
    let animationFrame = null;
    let coinBalance = 0;

    const dropButton = document.getElementById('dropButton');
    const resetButton = document.getElementById('resetButton');
    const scoreDisplay = document.getElementById('scoreDisplay');
    const coinDisplay = document.getElementById('coinDisplay');

    // Update coin display and button state
    function updateCoinDisplay() {
      coinDisplay.textContent = coinBalance;
      if (coinBalance < 300) {
        dropButton.title = "Low on coins";
        dropButton.classList.add('insufficient');
      } else {
        dropButton.title = "Drop a ball";
        dropButton.classList.remove('insufficient');
      }
      if (!gameActive && !gameComplete) {
        dropButton.disabled = false;
      }
    }

    // Update coin balance locally and sync with Firebase
    function updateCoins(amount) {
      coinBalance += amount;
      updateCoinDisplay();
      coinDisplay.style.animation = 'none';
      setTimeout(() => {
        coinDisplay.style.animation = 'glow 2s infinite';
      }, 10);
      if (window.updateFirebaseCoinBalance) {
        window.updateFirebaseCoinBalance(coinBalance);
      }
    }

    // Resize canvas based on container size
    function resizeCanvas() {
      const gameBoard = document.querySelector('.game-board');
      canvasWidth = gameBoard.clientWidth;
      canvasHeight = gameBoard.clientHeight;
      canvas.width = canvasWidth;
      canvas.height = canvasHeight;
      setupGame();
    }

    // Utility: Shuffle an array
    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    // Set up game elements
    function setupGame() {
      if (animationFrame) {
        cancelAnimationFrame(animationFrame);
      }
      ball = null;
      pegs = [];
      buckets = [];
      gameActive = false;
      gameComplete = false;
      updateCoinDisplay();
      const startX = canvasWidth / 2;
      const startY = 60;
      for (let row = 0; row < config.pegRows; row++) {
        const pegCount = row + 1;
        for (let i = 0; i < pegCount; i++) {
          const x = startX - (pegCount - 1) * config.pegSpacing / 2 + i * config.pegSpacing;
          const y = startY + row * config.pegSpacing;
          pegs.push({ x: x, y: y, radius: config.pegRadius });
        }
      }
      const lastRowWidth = config.pegSpacing * config.pegRows;
      const bucketWidth = lastRowWidth / config.buckets;
      const bucketY = startY + (config.pegRows) * config.pegSpacing + 20;
      const bucketStartX = startX - lastRowWidth / 2;
      const rewards = [];
      for (let i = 0; i < config.buckets; i++) {
        let reward;
        if (i < 2) {
          reward = Math.floor(Math.random() * (0 - config.minReward) + config.minReward);
        } else if (i >= config.buckets - 2) {
          reward = Math.floor(Math.random() * config.maxReward);
        } else {
          reward = Math.floor(Math.random() * (config.maxReward - config.minReward) + config.minReward);
        }
        rewards.push(reward);
      }
      shuffleArray(rewards);
      for (let i = 0; i < config.buckets; i++) {
        const x = bucketStartX + i * bucketWidth + bucketWidth / 2;
        buckets.push({ x: x, y: bucketY, width: bucketWidth, height: 40, reward: rewards[i] });
      }
      scoreDisplay.textContent = '';
      drawGame();
    }

    // Drop a new ball if game is not active
    function dropBall() {
      if (gameActive || gameComplete) return;
      updateCoins(-300);
      ball = { x: canvasWidth / 2, y: 20, radius: config.ballRadius, velocityX: 0, velocityY: config.dropSpeed };
      gameActive = true;
      dropButton.disabled = true;
      animateGame();
    }

    // Reset game state
    function resetGame() {
      setupGame();
    }

    // Main game loop
    function animateGame() {
      if (!gameActive) return;
      ctx.clearRect(0, 0, canvasWidth, canvasHeight);
      updateBall();
      drawGame();
      animationFrame = requestAnimationFrame(animateGame);
    }

    // Update ball physics and check collisions
    function updateBall() {
      if (!ball) return;
      ball.velocityY += config.gravity;
      ball.x += ball.velocityX;
      ball.y += ball.velocityY;
      for (const peg of pegs) {
        const dx = ball.x - peg.x;
        const dy = ball.y - peg.y;
        const distance = Math.sqrt(dx * dx + dy * dy);
        if (distance < ball.radius + peg.radius) {
          const angle = Math.atan2(dy, dx);
          const minDistance = ball.radius + peg.radius;
          ball.x = peg.x + Math.cos(angle) * minDistance;
          ball.y = peg.y + Math.sin(angle) * minDistance;
          const normalX = dx / distance;
          const normalY = dy / distance;
          const dotProduct = ball.velocityX * normalX + ball.velocityY * normalY;
          ball.velocityX -= 2 * dotProduct * normalX;
          ball.velocityY -= 2 * dotProduct * normalY;
          ball.velocityX *= config.friction * config.bounceSpeed;
          ball.velocityY *= config.friction * config.bounceSpeed;
          ball.velocityX += (Math.random() - 0.5) * 0.5;
        }
      }
      if (ball.x - ball.radius < 0) {
        ball.x = ball.radius;
        ball.velocityX = -ball.velocityX * config.friction;
      } else if (ball.x + ball.radius > canvasWidth) {
        ball.x = canvasWidth - ball.radius;
        ball.velocityX = -ball.velocityX * config.friction;
      }
      if (ball.y > buckets[0].y - ball.radius) {
        for (let i = 0; i < buckets.length; i++) {
          const bucket = buckets[i];
          if (ball.x > bucket.x - bucket.width / 2 && ball.x < bucket.x + bucket.width / 2) {
            gameComplete = true;
            gameActive = false;
            updateCoins(bucket.reward);
            if (bucket.reward >= 0) {
              scoreDisplay.innerHTML = `You won: <span class="win-amount">+${bucket.reward}</span>`;
            } else {
              scoreDisplay.innerHTML = `You lost: <span class="lose-amount">${bucket.reward}</span>`;
            }
            break;
          }
        }
      }
      if (ball.y - ball.radius > canvasHeight) {
        gameActive = false;
        dropButton.disabled = false;
      }
    }

    // Draw game elements on canvas
    function drawGame() {
      ctx.clearRect(0, 0, canvasWidth, canvasHeight);
      pegs.forEach(peg => {
        ctx.beginPath();
        ctx.arc(peg.x, peg.y, peg.radius, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
        ctx.fill();
        ctx.shadowColor = 'rgba(255, 255, 255, 0.8)';
        ctx.shadowBlur = 10;
        ctx.strokeStyle = 'white';
        ctx.lineWidth = 1;
        ctx.stroke();
        ctx.shadowBlur = 0;
      });
      buckets.forEach(bucket => {
        ctx.beginPath();
        ctx.rect(bucket.x - bucket.width / 2, bucket.y, bucket.width, bucket.height);
        ctx.fillStyle = 'rgba(40, 40, 40, 0.9)';
        ctx.fill();
        ctx.shadowColor = 'rgba(255, 255, 255, 0.8)';
        ctx.shadowBlur = 8;
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
        ctx.lineWidth = 2;
        ctx.stroke();
        ctx.shadowBlur = 0;
        ctx.font = 'bold 16px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        if (bucket.reward >= 0) {
          ctx.fillStyle = '#4caf50';
          ctx.fillText(`+${bucket.reward}`, bucket.x, bucket.y + bucket.height / 2);
        } else {
          ctx.fillStyle = '#f44336';
          ctx.fillText(`${bucket.reward}`, bucket.x, bucket.y + bucket.height / 2);
        }
      });
      if (pegs.length > 0) {
        const topPeg = pegs[0];
        const lastRowStartIndex = pegs.length - config.pegRows;
        const leftPeg = pegs[lastRowStartIndex];
        const rightPeg = pegs[pegs.length - 1];
        ctx.beginPath();
        ctx.moveTo(topPeg.x, topPeg.y - 20);
        ctx.lineTo(leftPeg.x - 20, buckets[0].y);
        ctx.lineTo(rightPeg.x + 20, buckets[0].y);
        ctx.closePath();
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
        ctx.lineWidth = 2;
        ctx.stroke();
      }
      if (ball) {
        ctx.beginPath();
        ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
        const gradient = ctx.createRadialGradient(
          ball.x - 3, ball.y - 3, 1,
          ball.x, ball.y, ball.radius
        );
        gradient.addColorStop(0, '#fff');
        gradient.addColorStop(1, '#aaa');
        ctx.fillStyle = gradient;
        ctx.fill();
        ctx.shadowColor = 'rgba(255, 255, 255, 0.8)';
        ctx.shadowBlur = 15;
        ctx.strokeStyle = 'white';
        ctx.lineWidth = 1;
        ctx.stroke();
        ctx.shadowBlur = 0;
      }
    }

    // Event listeners
    dropButton.addEventListener('click', dropBall);
    resetButton.addEventListener('click', resetGame);
    window.addEventListener('resize', resizeCanvas);
    window.addEventListener('load', () => {
      if (window.loadFirebaseCoinBalance) {
        window.loadFirebaseCoinBalance();
      }
      resizeCanvas();
      setupGame();
    });

    // Expose functions for external access (if needed)
    window.updateCoinDisplay = updateCoinDisplay;
    window.setupGame = setupGame;
  </script>
</body>
</html>
